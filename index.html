<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–ª–∞–Ω–µ—Ä ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø</title>
  <style>
    :root{
      --bg:#0f1220;
      --card:#171b2e;
      --muted:#8e97b3;
      --text:#e8ecff;
      --accent:#6dd3fb;
      --accent2:#22d3ee;
      --warn:#ff8a8a;
      --ok:#86efac;
      --line1:#7aa2ff;
      --line2:#ffb86b;
      --line3:#4ade80;
      --grid:#2a3050;
      --purple:#a78bfa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1a1f37 0%, #0f1220 60%) no-repeat fixed, var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    #app{
      max-width:1200px;
      margin:32px auto 80px;
      padding:0 16px;
    }
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted); margin-bottom:24px}
    .grid{
      display:grid;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{
        grid-template-columns: 1.1fr 1fr;
        align-items:start;
      }
    }
    section{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      border:1px solid #242a47;
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
    }
    section h2{
      margin:0 0 12px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }
    label{
      font-size:13px;
      color:var(--muted);
    }
    input, button, select{
      background:#0f1326;
      color:var(--text);
      border:1px solid #283158;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      transition:.15s border-color ease;
    }
    input:focus, select:focus{border-color:#3f5bd6}
    input[type="date"]{padding:9px 10px}
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .btn{
      background:linear-gradient(180deg, #3f5bd6, #334ec0);
      border:none;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      transition: transform 0.1s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{
      background:transparent;
      border:1px solid #334ec0;
    }
    .btn.accent{
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      color:#0f1220;
    }
    .btn.small{
      padding:6px 10px;
      font-size:13px;
    }
    .btn.icon{
      padding:8px;
      min-width:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.danger{
      background:linear-gradient(180deg, #dc2626, #b91c1c);
    }
    .note{
      font-size:13px;
      color:var(--muted);
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin:8px 0 4px;
    }
    @media (min-width:680px){
      .kpi{grid-template-columns: repeat(4, minmax(0,1fr));}
    }
    .tile{
      background: #0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .tile.highlight{
      background: linear-gradient(135deg, rgba(167,139,250,.06), rgba(109,211,251,.06));
      border-color:#4338ca;
    }
    .tile .label{font-size:12px;color:var(--muted)}
    .tile .value{font-size:18px;font-weight:700;margin-top:4px}
    .tile.warn{border-color:#4e1e2a;background:rgba(255,72,72,.06)}
    .tile.ok{border-color:#2d4a38;background:rgba(61, 194, 124, .06)}
    .warn-text{color:var(--warn); font-weight:600}
    .ok-text{color:var(--ok); font-weight:600}
    .divider{height:1px;background:#27305a;margin:14px 0}
    #chartWrap{
      background:#0d1122;
      border:1px solid #27305a;
      border-radius:12px;
      padding:10px;
    }
    canvas{width:100%; height:320px; display:block}
    .months{
      display:flex; flex-direction:column; gap:10px; margin-top:8px;
    }
    .month{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:12px;
      position:relative;
    }
    .month.current{
      border-color:#4338ca;
      background: linear-gradient(135deg, rgba(167,139,250,.03), rgba(109,211,251,.03));
    }
    .month-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .month-name{
      font-weight:600;
      font-size:15px;
    }
    .month-stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      margin-bottom:10px;
    }
    .stat-item{
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:8px;
      text-align:center;
    }
    .stat-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .stat-value{
      font-size:14px;
      font-weight:600;
    }
    .month-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .transactions{
      margin-top:10px;
      max-height:200px;
      overflow-y:auto;
    }
    .transaction{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 8px;
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:6px;
      margin-bottom:4px;
      font-size:13px;
    }
    .transaction .amount{
      font-weight:600;
      color:var(--warn);
    }
    .transaction .date{
      color:var(--muted);
      font-size:11px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid #27305a; padding:6px 10px; border-radius:999px; 
      font-size:12px; color:var(--muted);
    }
    .pill.accent{
      background:rgba(109,211,251,.1);
      border-color:var(--accent);
      color:var(--accent);
    }
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 0}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.plan{background:var(--line1)}
    .dot.actual{background:var(--line2)}
    .dot.forecast{background:var(--line3)}
    .footer-note{margin-top:14px; font-size:12px; color:var(--muted)}
    .right{justify-self:end}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    
    /* Modal */
    .modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      opacity:0;
      visibility:hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .modal.show{
      opacity:1;
      visibility:visible;
    }
    .modal-content{
      background:var(--card);
      border:1px solid #27305a;
      border-radius:16px;
      padding:24px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .modal-title{
      font-size:18px;
      font-weight:700;
    }
    .modal-close{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:20px;
      cursor:pointer;
      padding:0;
      width:28px;
      height:28px;
    }
    .modal-close:hover{color:var(--text)}
    
    /* Mandatory Payments */
    .mandatory-section{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:14px;
      margin-bottom:14px;
    }
    .mandatory-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .mandatory-title{
      font-size:15px;
      font-weight:600;
    }
    .mandatory-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .mandatory-item{
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .mandatory-info{
      flex:1;
    }
    .mandatory-name{
      font-size:14px;
      font-weight:500;
      margin-bottom:2px;
    }
    .mandatory-details{
      font-size:12px;
      color:var(--muted);
    }
    .mandatory-amount{
      font-size:16px;
      font-weight:700;
      color:var(--purple);
      margin-right:10px;
    }
    
    /* Recommendations */
    .recommendations{
      background: linear-gradient(135deg, rgba(167,139,250,.08), rgba(109,211,251,.08));
      border:1px solid #4338ca;
      border-radius:12px;
      padding:14px;
      margin-top:12px;
    }
    .rec-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:10px;
      color:var(--purple);
    }
    .rec-grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:10px;
    }
    @media (min-width:600px){
      .rec-grid{grid-template-columns: repeat(3,1fr);}
    }
    .rec-item{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:8px;
      padding:10px;
      text-align:center;
    }
    .rec-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .rec-value{
      font-size:16px;
      font-weight:700;
      color:var(--accent);
    }
    
    .badge{
      background:var(--accent);
      color:#0f1220;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:700;
      margin-left:6px;
    }
    
    .input-group{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .input-group .field{
      flex:1;
    }
    .input-group .btn{
      margin-bottom:10px;
    }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Å—è—Ü–∞ */
    .month{
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .month:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,.3);
    }
    
    #monthDetailModal .modal-content{
      max-width: 600px;
    }
    
    .month-detail-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .month-detail-title{
      font-size: 20px;
      font-weight: 700;
    }
    
    .pie-chart-container{
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      position: relative;
    }
    
    #pieChart{
      max-width: 280px;
      max-height: 280px;
    }
    
    .chart-legend{
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
    }
    
    .legend-item{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .legend-color{
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    
    .detail-stats{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .detail-stat{
      background: #0f1326;
      border: 1px solid #27305a;
      border-radius: 10px;
      padding: 12px;
    }
    
    .detail-stat-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .detail-stat-value{
      font-size: 18px;
      font-weight: 700;
    }
    
    .overspent{
      color: #ff4444;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ */
    .month-toggle-btn {
      background: transparent;
      border: 1px solid #27305a;
      color: var(--muted);
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .month-toggle-btn:hover {
      background: rgba(109,211,251,.1);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .month.collapsed .month-content {
      display: none;
    }
    
    .month.collapsed {
      padding: 10px 12px;
    }
    
    .month.collapsed .month-header {
      margin-bottom: 0;
    }
    
    .month-toggle-btn.collapsed {
      transform: rotate(-90deg);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Å—Ä–µ–¥–Ω–µ–π —Ç—Ä–∞—Ç—ã */
.daily-avg-good {
  background: linear-gradient(135deg, rgba(134,239,172,.12), rgba(74,222,128,.12)) !important;
  border-color: #4ade80 !important;
}

.daily-avg-normal {
  background: linear-gradient(135deg, rgba(109,211,251,.08), rgba(167,139,250,.08)) !important;
  border-color: #4338ca !important;
}

.daily-avg-bad {
  background: linear-gradient(135deg, rgba(255,138,138,.12), rgba(255,68,68,.12)) !important;
  border-color: #ff4444 !important;
}

.daily-avg-value.good {
  color: #4ade80 !important;
}

.daily-avg-value.bad {
  color: #ff8a8a !important;
}

.progress-indicator {
  display: inline-block;
  margin-left: 8px;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
}

.progress-indicator.good {
  background: rgba(134,239,172,.2);
  color: #4ade80;
}

.progress-indicator.normal {
  background: rgba(109,211,251,.2);
  color: var(--accent);
}

.progress-indicator.bad {
  background: rgba(255,138,138,.2);
  color: #ff8a8a;
}
    
    

  </style>
</head>
<body>
  <div id="app">
    <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–ª–∞–Ω–µ—Ä</h1>
    <div class="sub">–ù–∞–≤–µ–¥–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ —Ç—Ä–∞—Ç–∞—Ö –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–≤–∏–≥–∞–π—Å—è –∫ —Ü–µ–ª–∏. –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è, –¥–æ–±–∞–≤—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å –¥–∞—Ç–∞–º–∏ –æ–ø–ª–∞—Ç—ã –∏ —Å–º–æ—Ç—Ä–∏, –∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç.</div>

    <div class="grid">
      <!-- –í–í–û–î –î–ê–ù–ù–´–• -->
      <section id="input-section">
        <h2>–í–∞—à –ø–ª–∞–Ω</h2>

        <div class="field">
          <label for="initial">–ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª, ‚ÇΩ</label>
          <input id="initial" type="number" inputmode="decimal" min="0" step="100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 100000" />
        </div>

        <div class="field">
          <label for="target">–¶–µ–ª–µ–≤–æ–π –±–∞–ª–∞–Ω—Å –∫ –∫–æ–Ω—Ü—É –ø–µ—Ä–∏–æ–¥–∞, ‚ÇΩ</label>
          <input id="target" type="number" inputmode="decimal" min="0" step="100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 50000" />
        </div>

        <div class="row">
          <div class="field">
            <label for="start">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
            <input id="start" type="date" />
          </div>
          <div class="field">
            <label for="end">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
            <input id="end" type="date" />
          </div>
        </div>

        <!-- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ -->
        <div class="mandatory-section">
          <div class="mandatory-header">
            <div class="mandatory-title">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
            <button class="btn accent small" onclick="openMandatoryModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div id="mandatoryList" class="mandatory-list">
            <div class="note">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
          </div>
        </div>

        <div class="actions">
          <button id="calcBtn" class="btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
          <button id="resetBtn" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <span class="pill" id="monthsInfo">–ú–µ—Å—è—Ü–µ–≤: ‚Äî</span>
        </div>
        <div class="note">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.</div>
      </section>

      <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò –ì–†–ê–§–ò–ö -->
      <section id="results-section">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>

        <div class="kpi">
          <div class="tile">
            <div class="label">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ç—Ä–∞—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <div class="value" id="availableTotal">‚Äî</div>
            <div class="small">–ü–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö</div>
          </div>

          <div class="tile" id="limitTile">
            <div class="label">–õ–∏–º–∏—Ç —Ç—Ä–∞—Ç –≤ –º–µ—Å—è—Ü (–±–∞–∑–æ–≤—ã–π)</div>
            <div class="value" id="monthlyLimit">‚Äî</div>
            <div class="small">–ë–µ–∑ —É—á—ë—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö</div>
          </div>

          <div class="tile">
            <div class="label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <div class="value" id="mandatoryTotal">‚Äî</div>
          </div>

          <div class="tile" id="feasibilityTile">
            <div class="label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∞–Ω–∞</div>
            <div class="value" id="feasibility">‚Äî</div>
          </div>
        </div>

        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div id="recommendationsBlock" class="recommendations hidden">
          <div class="rec-title">üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã</div>
          <div class="rec-grid">
            <div class="rec-item">
              <div class="rec-label">–í –¥–µ–Ω—å</div>
              <div class="rec-value" id="dailyLimit">‚Äî</div>
            </div>
            <div class="rec-item">
              <div class="rec-label">–í –Ω–µ–¥–µ–ª—é</div>
              <div class="rec-value" id="weeklyLimit">‚Äî</div>
            </div>
            <div class="rec-item">
              <div class="rec-label">–í 10 –¥–Ω–µ–π</div>
              <div class="rec-value" id="tenDaysLimit">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="chartWrap">
          <canvas id="chart" width="1000" height="360"></canvas>
          <div class="legend">
            <span class="pill"><span class="dot plan"></span> –ü–ª–∞–Ω –ø–æ –±–∞–ª–∞–Ω—Å—É</span>
            <span class="pill"><span class="dot actual"></span> –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å</span>
            <span class="pill"><span class="dot forecast"></span> –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ –∫–æ–Ω—Ü–∞</span>
          </div>
        </div>
      </section>
    </div>

    <!-- –§–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ê–¢–´ -->
    <section id="actual-spending-section">
      <h2>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞—Ç—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
      <div class="note">–î–æ–±–∞–≤–ª—è–π —Ä–∞—Å—Ö–æ–¥—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "+" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      
      <div id="monthsList" class="months"></div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="tile">
          <div class="label">–£—á—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤</div>
          <div class="value" id="countSaved">‚Äî</div>
        </div>
        <div class="tile">
          <div class="label">–°—É–º–º–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞—Ç</div>
          <div class="value" id="sumActual">‚Äî</div>
        </div>
        <div class="tile">
          <div class="label">–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞ –ø–µ—Ä–∏–æ–¥</div>
          <div class="value" id="remainingTotal">‚Äî</div>
        </div>
        <div class="tile highlight" id="newLimitTile">
          <div class="label">–ù–æ–≤—ã–π –ª–∏–º–∏—Ç –≤ –º–µ—Å—è—Ü</div>
          <div class="value" id="newMonthlyLimit">‚Äî</div>
          <div class="small">–° —É—á—ë—Ç–æ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞—Ç</div>
        </div>
      </div>

      <div id="unfeasibleMsg" class="tile warn hidden" style="margin-top:10px;">
        <div class="label warn-text">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
        <div class="value" style="font-size:16px;font-weight:600;">
          –ü–ª–∞–Ω –Ω–µ–≤—ã–ø–æ–ª–Ω–∏–º. –£–≤–µ–ª–∏—á—å—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏.
        </div>
      </div>
    </section>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç—ã -->
  <div id="addExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h3>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="field">
        <label>–ú–µ—Å—è—Ü</label>
        <input type="text" id="modalMonth" readonly style="background:#0b0f1e;">
      </div>
      <div class="field">
        <label for="expenseAmount">–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞, ‚ÇΩ</label>
        <input type="number" id="expenseAmount" inputmode="decimal" min="0" step="100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000">
      </div>
      <div class="field">
        <label for="expenseDesc">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="text" id="expenseDesc" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü—Ä–æ–¥—É–∫—Ç—ã">
      </div>
      <div class="actions">
        <button class="btn accent" onclick="saveExpense()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π -->
  <div id="mandatoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂</h3>
        <button class="modal-close" onclick="closeMandatoryModal()">√ó</button>
      </div>
      <div class="field">
        <label for="mandatoryName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
        <input type="text" id="mandatoryName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã">
      </div>
      <div class="field">
        <label for="mandatoryAmount">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞, ‚ÇΩ</label>
        <input type="number" id="mandatoryAmount" inputmode="decimal" min="0" step="100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 30000">
      </div>
      <div class="field">
        <label for="mandatoryDay">–î–µ–Ω—å –º–µ—Å—è—Ü–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã (1-31)</label>
        <input type="number" id="mandatoryDay" min="1" max="31" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 5">
        <small class="note">–ü–ª–∞—Ç–µ–∂ –±—É–¥–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–µ—Å—è—Ü–∞—Ö, –≥–¥–µ —ç—Ç–∞ –¥–∞—Ç–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</small>
      </div>
      <div class="actions">
        <button class="btn accent" onclick="saveMandatory()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn ghost" onclick="closeMandatoryModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Å—è—Ü–∞ -->
  <div id="monthDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="monthDetailTitle">–î–µ—Ç–∞–ª–∏ –º–µ—Å—è—Ü–∞</h3>
        <button class="modal-close" onclick="closeMonthDetailModal()">√ó</button>
      </div>
      
      <div class="pie-chart-container">
        <canvas id="pieChart" width="280" height="280"></canvas>
      </div>
      
      <div class="chart-legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #4ade80;"></div>
          <span>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ç—Ä–∞—Ç</span>
          <span id="legendAvailable" style="margin-left:auto; font-weight:600;">‚Äî</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ff8a8a;"></div>
          <span>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–ª–∞–Ω–∞)</span>
          <span id="legendSpent" style="margin-left:auto; font-weight:600;">‚Äî</span>
        </div>
        <div class="legend-item" id="overspentLegend" style="display:none;">
          <div class="legend-color" style="background: #ff4444;"></div>
          <span>–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥</span>
          <span id="legendOverspent" style="margin-left:auto; font-weight:600; color:#ff4444;">‚Äî</span>
        </div>
      </div>
      
      <div class="detail-stats">
        <div class="detail-stat">
          <div class="detail-stat-label">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</div>
          <div class="detail-stat-value" id="detailPlan">‚Äî</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
          <div class="detail-stat-value" id="detailMandatory">‚Äî</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
          <div class="detail-stat-value" id="detailActual">‚Äî</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">–û—Å—Ç–∞—Ç–æ–∫/–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥</div>
          <div class="detail-stat-value" id="detailBalance">‚Äî</div>
        </div>
      </div>
      
      <div class="actions" style="margin-top: 20px;">
        <button class="btn ghost" onclick="closeMonthDetailModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>


  <script>
    // ===========================
    // –£–¢–ò–õ–ò–¢–´
    // ===========================
    const fmt = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'RUB', maximumFractionDigits:0 });
    const fmt0 = (n)=> n===null || Number.isNaN(n) ? '‚Äî' : fmt.format(n);
    const fmtShort = (n)=> {
      if(!Number.isFinite(n)) return '‚Äî';
      if(n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if(n >= 1000) return (n/1000).toFixed(1) + 'K';
      return Math.round(n).toString();
    };

    function num(el){
      const v = parseFloat(el.value.replace(',', '.'));
      return Number.isFinite(v) ? v : 0;
    }

    function monthsDiffCeil(start, end){
      if(!start || !end) return 0;
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      if(e <= s) return 0;
      let diff = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth());
      if(e.getDate() > s.getDate()) diff += 1;
      return diff;
    }

    function monthLabels(start, months){
      const labels = [];
      for(let i=0;i<months;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
        const label = d.toLocaleDateString('ru-RU', { month:'long', year:'numeric' });
        labels.push(capitalize(label));
      }
      return labels;
    }
    
    function capitalize(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

    function isCurrentMonth(monthIndex){
      if(!state.start) return false;
      const now = new Date();
      const monthDate = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
      return now.getFullYear() === monthDate.getFullYear() && now.getMonth() === monthDate.getMonth();
    }

    // ===========================
    // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ===========================
    const state = {
      initial: 0,
      target: 0,
      start: null,
      end: null,
      months: 0,
      mandatoryPayments: [], // –ú–∞—Å—Å–∏–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π [{name, amount, dayOfMonth}]
      monthlyTransactions: [], // –ú–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º
      labels: [],
      currentModalMonth: -1,
      collapsedMonths: {} // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    };

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const STORAGE_KEY = 'finplanner_state_v3';
    function saveState(){
      try{
        const payload = {
          ...state,
          start: state.start ? state.start.toISOString() : null,
          end: state.end ? state.end.toISOString() : null,
          collapsedMonths: state.collapsedMonths // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){}
    }
    
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        state.initial = obj.initial ?? 0;
        state.target = obj.target ?? 0;
        state.start = obj.start ? new Date(obj.start) : null;
        state.end = obj.end ? new Date(obj.end) : null;
        state.months = obj.months ?? 0;
        state.mandatoryPayments = obj.mandatoryPayments ?? [];
        state.monthlyTransactions = obj.monthlyTransactions ?? [];
        state.labels = obj.labels ?? [];
        state.collapsedMonths = obj.collapsedMonths ?? {}; // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
      }catch(e){}
    }

    // ===========================
    // –†–ê–°–ß–ï–¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ü–õ–ê–¢–ï–ñ–ï–ô
    // ===========================
    function calculateMandatoryForMonth(monthIndex){
      if(!state.start || !state.end) return 0;
      
      const monthStart = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
      const monthEnd = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex + 1, 0);
      
      let total = 0;
      
      for(const payment of state.mandatoryPayments){
        const paymentDate = new Date(monthStart.getFullYear(), monthStart.getMonth(), payment.dayOfMonth);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        if(paymentDate >= state.start && paymentDate <= state.end){
          // –ò —á—Ç–æ –¥–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
          if(paymentDate.getMonth() === monthStart.getMonth()){
            total += payment.amount;
          }
        }
      }
      
      return total;
    }

    function calculateTotalMandatory(){
      let total = 0;
      for(let i = 0; i < state.months; i++){
        total += calculateMandatoryForMonth(i);
      }
      return total;
    }

    function calculateTotalMandatory(){
      let total = 0;
      for(let i = 0; i < state.months; i++){
        total += calculateMandatoryForMonth(i);
      }
      return total;
    }

     // ===========================
    // –†–ê–°–ß–ï–¢ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–• –õ–ò–ú–ò–¢–û–í
    // ===========================
    function calculateDynamicLimitForMonth(monthIndex, baseMonthlyLimit, monthlyActuals){
      // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –ª–∏–º–∏—Ç –µ—Å–ª–∏ –≤ –Ω–µ–º –µ—â–µ –Ω–µ—Ç —Ç—Ä–∞—Ç
      if(monthIndex === 0 && monthlyActuals[0] === 0){
        return baseMonthlyLimit;
      }
      
      // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü —Å —Ç—Ä–∞—Ç–∞–º–∏
      let lastMonthWithExpenses = -1;
      for(let i = 0; i < monthlyActuals.length; i++){
        if(monthlyActuals[i] > 0){
          lastMonthWithExpenses = i;
        }
      }
      
      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü —É–∂–µ –∏–º–µ–µ—Ç —Ç—Ä–∞—Ç—ã –∏–ª–∏ —ç—Ç–æ –ø—Ä–æ—à–µ–¥—à–∏–π –º–µ—Å—è—Ü - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω
      if(monthIndex <= lastMonthWithExpenses){
        return baseMonthlyLimit;
      }
      
      // –î–ª—è –±—É–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞–Ω
      // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ (–≤–∫–ª—é—á–∞—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
      let totalSpentSoFar = 0;
      for(let i = 0; i <= lastMonthWithExpenses; i++){
        totalSpentSoFar += monthlyActuals[i] + calculateMandatoryForMonth(i);
      }
      
      // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤ –±—É–¥—É—â–∏—Ö –º–µ—Å—è—Ü–∞—Ö
      let futureMandatory = 0;
      for(let i = lastMonthWithExpenses + 1; i < state.months; i++){
        futureMandatory += calculateMandatoryForMonth(i);
      }
      
      // –û–±—â–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è —Å—É–º–º–∞ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
      const totalAvailableForPeriod = (state.initial - state.target) - calculateTotalMandatory();
      
      // –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞—Ç (–±–µ–∑ —É—á–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —É–∂–µ –≤—ã—á—Ç–µ–Ω—ã –∏–∑ totalAvailableForPeriod)
      const actualSpentWithoutMandatory = monthlyActuals.reduce((sum, v) => sum + v, 0);
      const remainingAfterActual = totalAvailableForPeriod - actualSpentWithoutMandatory;
      
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–µ—Å—è—Ü–µ–≤ (–ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—è—Ü–∞ —Å —Ç—Ä–∞—Ç–∞–º–∏)
      const remainingMonths = state.months - lastMonthWithExpenses - 1;
      
      // –ù–æ–≤—ã–π —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–µ—Å—è—Ü–µ–≤
      if(remainingMonths > 0){
        return remainingAfterActual / remainingMonths;
      }
      
      return 0;
    }

    // ===========================
    // –†–ê–°–ß–ï–¢ –°–†–ï–î–ù–ï–ô –¢–†–ê–¢–´ –ó–ê –î–ï–ù–¨
    // ===========================
    function calculateDailyAverage(monthIndex, dynamicLimit) {
  if (!state.start || !state.end) return null;
  if (!isCurrentMonth(monthIndex)) return null;
  
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  // –ì—Ä–∞–Ω–∏—Ü—ã –º–µ—Å—è—Ü–∞
  const monthStart = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
  const monthEnd = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex + 1, 0);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ –æ—Ç—Å—á–µ—Ç–∞
  let countStart;
  if (monthIndex === 0) {
    // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—è—Ü–∞ –±–µ—Ä–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø–ª–∞–Ω–∞
    countStart = new Date(state.start.getFullYear(), state.start.getMonth(), state.start.getDate());
  } else {
    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤ - –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
    countStart = monthStart;
  }
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü –æ—Ç—Å—á–µ—Ç–∞ (–º–∏–Ω–∏–º—É–º –∏–∑: —Å–µ–≥–æ–¥–Ω—è, –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞, –∫–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞)
  let countEnd = today;
  if (monthEnd < countEnd) countEnd = monthEnd;
  if (state.end < countEnd) countEnd = state.end;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤–∞–ª–∏–¥–Ω—ã–π
  if (countEnd < countStart) return null;
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
  const daysCount = Math.floor((countEnd - countStart) / (1000 * 60 * 60 * 24)) + 1;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
  const transactions = state.monthlyTransactions[monthIndex] || [];
  
  // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É —Ç—Ä–∞—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥
  let totalSpent = 0;
  transactions.forEach(t => {
    const transDate = new Date(t.date);
    const transDateOnly = new Date(transDate.getFullYear(), transDate.getMonth(), transDate.getDate());
    if (transDateOnly >= countStart && transDateOnly <= countEnd) {
      totalSpent += t.amount || 0;
    }
  });
  
  const dailyAvg = totalSpent / daysCount;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ª–∏–º–∏—Ç
  const recommendedDailyLimit = dynamicLimit / 30; // –ü—Ä–∏–º–µ—Ä–Ω–æ 30 –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
  const recommendedTotalForDays = recommendedDailyLimit * daysCount;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (—Ö–æ—Ä–æ—à–æ/–Ω–æ—Ä–º–∞–ª—å–Ω–æ/–ø–ª–æ—Ö–æ)
  const percentage = (totalSpent / recommendedTotalForDays) * 100;
  let status = 'normal';
  if (percentage < 90) status = 'good';
  else if (percentage > 110) status = 'bad';
  
  return {
    average: dailyAvg,
    days: daysCount,
    total: totalSpent,
    recommendedDaily: recommendedDailyLimit,
    recommendedTotal: recommendedTotalForDays,
    percentage: percentage,
    status: status
  };
}


    // ===========================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï–ú –ú–ï–°–Ø–¶–ï–í
    // ===========================
    function toggleMonth(monthIndex) {
      const monthId = `month_${monthIndex}`;
      state.collapsedMonths[monthId] = !state.collapsedMonths[monthId];
      saveState();
      
      const monthDiv = document.querySelector(`[data-month-index="${monthIndex}"]`);
      if (monthDiv) {
        if (state.collapsedMonths[monthId]) {
          monthDiv.classList.add('collapsed');
        } else {
          monthDiv.classList.remove('collapsed');
        }
        
        const toggleBtn = monthDiv.querySelector('.month-toggle-btn');
        if (toggleBtn) {
          if (state.collapsedMonths[monthId]) {
            toggleBtn.classList.add('collapsed');
          } else {
            toggleBtn.classList.remove('collapsed');
          }
        }
      }
    }

    // ===========================
    // DOM –≠–õ–ï–ú–ï–ù–¢–´
    // ===========================
    const $initial = document.getElementById('initial');
    const $target = document.getElementById('target');
    const $start = document.getElementById('start');
    const $end = document.getElementById('end');
    const $calcBtn = document.getElementById('calcBtn');
    const $resetBtn = document.getElementById('resetBtn');
    const $monthsInfo = document.getElementById('monthsInfo');
    const $availableTotal = document.getElementById('availableTotal');
    const $monthlyLimit = document.getElementById('monthlyLimit');
    const $mandatoryTotal = document.getElementById('mandatoryTotal');
    const $feasibility = document.getElementById('feasibility');
    const $limitTile = document.getElementById('limitTile');
    const $feasibilityTile = document.getElementById('feasibilityTile');
    const $monthsList = document.getElementById('monthsList');
    const $countSaved = document.getElementById('countSaved');
    const $sumActual = document.getElementById('sumActual');
    const $remainingTotal = document.getElementById('remainingTotal');
    const $newMonthlyLimit = document.getElementById('newMonthlyLimit');
    const $newLimitTile = document.getElementById('newLimitTile');
    const $unfeasibleMsg = document.getElementById('unfeasibleMsg');
    const $recommendationsBlock = document.getElementById('recommendationsBlock');
    const $dailyLimit = document.getElementById('dailyLimit');
    const $weeklyLimit = document.getElementById('weeklyLimit');
    const $tenDaysLimit = document.getElementById('tenDaysLimit');
    const $chart = document.getElementById('chart');
    const ctx = $chart.getContext('2d');
    const $mandatoryList = document.getElementById('mandatoryList');

    // ===========================
    // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
    // ===========================
    function recalcAll(){
      state.initial = Math.max(0, num($initial));
      state.target = Math.max(0, num($target));
      state.start = $start.value ? new Date($start.value) : null;
      state.end = $end.value ? new Date($end.value) : null;
      state.months = monthsDiffCeil(state.start, state.end);
      $monthsInfo.textContent = `–ú–µ—Å—è—Ü–µ–≤: ${state.months || '‚Äî'}`;

      if(state.months <= 0 || !state.start || !state.end){
        state.labels = [];
        state.monthlyTransactions = [];
        renderResults({availableTotal:null, monthlyLimit:null, mandatoryTotal:null, feasible:null, newMonthlyLimit:null, remTotal:null, sumActual:null, countSaved:null});
        $monthsList.innerHTML = '';
        drawChart([], [], [], []);
        $recommendationsBlock.classList.add('hidden');
        saveState();
        return;
      }

      state.labels = monthLabels(state.start, state.months);
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º
      if(state.monthlyTransactions.length !== state.months){
        const next = new Array(state.months).fill(null).map((_, i) => 
          state.monthlyTransactions[i] || []
        );
        state.monthlyTransactions = next;
      }

      // –†–∞—Å—á—ë—Ç—ã —Å —É—á–µ—Ç–æ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
      const mandatoryTotal = calculateTotalMandatory();
      const availableTotal = (state.initial - state.target) - mandatoryTotal;
      const monthlyLimit = availableTotal / state.months;
      
      // –ü–æ–¥—Å—á—ë—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞—Ç
      const monthlyActuals = state.monthlyTransactions.map(transactions => 
        transactions.reduce((sum, t) => sum + (t.amount || 0), 0)
      );
      const countSaved = monthlyActuals.filter(v => v > 0).length;
      const sumActual = monthlyActuals.reduce((sum, v) => sum + v, 0);
      
      const remTotal = availableTotal - sumActual;
      const remainingMonths = Math.max(0, state.months - countSaved);
      const newMonthlyLimit = remainingMonths > 0 ? (remTotal / remainingMonths) : 0;
      const feasible = monthlyLimit >= 0 && remTotal >= 0;

      renderResults({
        availableTotal,
        monthlyLimit,
        mandatoryTotal,
        feasible,
        newMonthlyLimit,
        remTotal,
        sumActual,
        countSaved
      });

      renderMandatoryPayments();
      renderMonthsList(monthlyLimit, newMonthlyLimit);
      renderRecommendations(newMonthlyLimit);

      // –ì—Ä–∞—Ñ–∏–∫
      const plannedBalances = makePlannedBalances(state.initial, state.target, state.months);
      const { actualBalances, forecastBalances } = makeActualAndForecastBalances(
        plannedBalances, state.initial, monthlyActuals, newMonthlyLimit
      );
      drawChart(state.labels, plannedBalances, actualBalances, forecastBalances);

      saveState();
    }

    function renderMandatoryPayments(){
      if(state.mandatoryPayments.length === 0){
        $mandatoryList.innerHTML = '<div class="note">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>';
        return;
      }

      $mandatoryList.innerHTML = '';
      state.mandatoryPayments.forEach((payment, idx) => {
        const div = document.createElement('div');
        div.className = 'mandatory-item';
        div.innerHTML = `
          <div class="mandatory-info">
            <div class="mandatory-name">${payment.name}</div>
            <div class="mandatory-details">–û–ø–ª–∞—Ç–∞: ${payment.dayOfMonth} —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞</div>
          </div>
          <div class="mandatory-amount">${fmt0(payment.amount)}</div>
          <button class="btn danger small" onclick="deleteMandatory(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        $mandatoryList.appendChild(div);
      });
    }

    function renderRecommendations(monthlyLimit){
      if(!Number.isFinite(monthlyLimit) || monthlyLimit <= 0){
        $recommendationsBlock.classList.add('hidden');
        return;
      }
      $recommendationsBlock.classList.remove('hidden');
      const daily = monthlyLimit / 30;
      const weekly = monthlyLimit / 4.3;
      const tenDays = monthlyLimit / 3;
      
      $dailyLimit.textContent = fmtShort(daily) + ' ‚ÇΩ';
      $weeklyLimit.textContent = fmtShort(weekly) + ' ‚ÇΩ';
      $tenDaysLimit.textContent = fmtShort(tenDays) + ' ‚ÇΩ';
    }

    function makePlannedBalances(initial, target, months){
      const arr = [];
      for(let i=0;i<=months;i++){
        const t = i / months;
        const y = initial + (target - initial) * t;
        arr.push(y);
      }
      return arr;
    }

        function makeActualAndForecastBalances(planned, initial, monthlyActuals, newMonthlyLimit){
      const actual = [initial];
      let currentBalance = initial;
      let savedCount = 0;
      
      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–∞—Ç–∞–º–∏
      for(let i=0;i<monthlyActuals.length;i++){
        const v = monthlyActuals[i];
        const mandatoryForMonth = calculateMandatoryForMonth(i);
        
        if(v > 0){
          currentBalance = currentBalance - mandatoryForMonth - v;
          actual.push(currentBalance);
          savedCount++;
        }
        else {
          break;
        }
      }
      
      // –°—Ç—Ä–æ–∏–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–µ—Å—è—Ü—ã
      const forecast = [];
      if(savedCount < state.months){
        forecast.push(currentBalance);
        
        // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞ –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–µ—Å—è—Ü—ã
        const totalAvailableForPeriod = (state.initial - state.target) - calculateTotalMandatory();
        const actualSpentWithoutMandatory = monthlyActuals.reduce((sum, v) => sum + v, 0);
        const remainingAfterActual = totalAvailableForPeriod - actualSpentWithoutMandatory;
        const remainingMonths = state.months - savedCount;
        const equalMonthlyLimit = remainingMonths > 0 ? remainingAfterActual / remainingMonths : 0;
        
        for(let i = savedCount; i < state.months; i++){
          const mandatoryForMonth = calculateMandatoryForMonth(i);
          const monthlyTotalSpend = mandatoryForMonth + Math.max(0, equalMonthlyLimit);
          currentBalance = currentBalance - monthlyTotalSpend;
          forecast.push(currentBalance);
        }
      }
      
      return { actualBalances: actual, forecastBalances: forecast };
    }


    function renderResults(data){
      const {
        availableTotal, monthlyLimit, mandatoryTotal,
        feasible, newMonthlyLimit, remTotal, sumActual, countSaved
      } = data;

      $availableTotal.textContent = fmt0(availableTotal);
      $monthlyLimit.textContent = Number.isFinite(monthlyLimit) ? fmt0(monthlyLimit) : '‚Äî';
      $mandatoryTotal.textContent = fmt0(mandatoryTotal);
      $feasibility.textContent = feasible===null ? '‚Äî' : (feasible ? '–í—ã–ø–æ–ª–Ω–∏–º ‚úì' : '–ù–µ–≤—ã–ø–æ–ª–Ω–∏–º ‚úó');
      $feasibilityTile.classList.toggle('warn', feasible===false);
      $feasibilityTile.classList.toggle('ok', feasible===true);
      $limitTile.classList.toggle('warn', Number.isFinite(monthlyLimit) && monthlyLimit < 0);
      $limitTile.classList.toggle('ok', Number.isFinite(monthlyLimit) && monthlyLimit >= 0);

      $countSaved.textContent = countSaved ?? '‚Äî';
      $sumActual.textContent = fmt0(sumActual);
      $remainingTotal.textContent = fmt0(remTotal);
      $newMonthlyLimit.textContent = Number.isFinite(newMonthlyLimit) ? fmt0(newMonthlyLimit) : '‚Äî';
      $newLimitTile.classList.toggle('warn', Number.isFinite(newMonthlyLimit) && newMonthlyLimit < 0);
      $newLimitTile.classList.toggle('ok', Number.isFinite(newMonthlyLimit) && newMonthlyLimit >= 0);

      const showUnfeasible = Number.isFinite(monthlyLimit) && monthlyLimit < 0;
      $unfeasibleMsg.classList.toggle('hidden', !showUnfeasible);
    }

        function renderMonthsList(baseMonthlyLimit, currentLimit){
  $monthsList.innerHTML = '';
  if(state.months <= 0) return;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞—Ç—ã
  const monthlyActuals = state.monthlyTransactions.map(transactions => 
    transactions.reduce((sum, t) => sum + (t.amount || 0), 0)
  );

  state.labels.forEach((label, idx) => {
    const transactions = state.monthlyTransactions[idx] || [];
    const monthTotal = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
    const mandatoryForMonth = calculateMandatoryForMonth(idx);
    const hasTransactions = transactions.length > 0;
    const isCurrent = isCurrentMonth(idx);
    
    // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
    const dynamicLimit = calculateDynamicLimitForMonth(idx, baseMonthlyLimit, monthlyActuals);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ç—Ä–∞—Ç—É –∑–∞ –¥–µ–Ω—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const dailyAverage = isCurrent ? calculateDailyAverage(idx, dynamicLimit) : null;
    
    const isOverspent = monthTotal > dynamicLimit;
    const isNegativeLimit = dynamicLimit < 0;

    const monthDiv = document.createElement('div');
    monthDiv.className = 'month' + (isCurrent ? ' current' : '');
    monthDiv.setAttribute('data-month-index', idx);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –¥–æ–ª–∂–µ–Ω –ª–∏ –º–µ—Å—è—Ü –±—ã—Ç—å —Å–≤–µ—Ä–Ω—É—Ç
    const monthId = `month_${idx}`;
    const isCollapsed = !isCurrent && (state.collapsedMonths[monthId] !== false);
    if (isCollapsed) {
      monthDiv.classList.add('collapsed');
      state.collapsedMonths[monthId] = true;
    }
    
    if(isOverspent) monthDiv.style.borderColor = '#dc2626';
    if(isNegativeLimit) monthDiv.style.background = 'rgba(220, 38, 38, 0.1)';

    // Header —Å –∫–Ω–æ–ø–∫–æ–π —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    const header = document.createElement('div');
    header.className = 'month-header';
    
    const leftHeader = document.createElement('div');
    leftHeader.style.display = 'flex';
    leftHeader.style.alignItems = 'center';
    leftHeader.style.flex = '1';
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'month-name';
    nameDiv.textContent = label;
    if(isCurrent){
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = '–¢–ï–ö–£–©–ò–ô';
      nameDiv.appendChild(badge);
    }
    
    // –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'month-toggle-btn' + (isCollapsed ? ' collapsed' : '');
    toggleBtn.innerHTML = '‚ñº';
    toggleBtn.title = isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å' : '–°–≤–µ—Ä–Ω—É—Ç—å';
    toggleBtn.onclick = (e) => {
      e.stopPropagation();
      toggleMonth(idx);
    };
    
    leftHeader.appendChild(nameDiv);
    leftHeader.appendChild(toggleBtn);

    const rightHeader = document.createElement('div');
    rightHeader.style.display = 'flex';
    rightHeader.style.alignItems = 'center';
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn accent icon small';
    addBtn.innerHTML = '+';
    addBtn.title = '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';
    addBtn.onclick = (e) => {
      e.stopPropagation();
      // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–µ—Å—è—Ü –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞
      if (state.collapsedMonths[monthId]) {
        toggleMonth(idx);
      }
      openAddExpenseModal(idx, label);
    };
    
    rightHeader.appendChild(addBtn);

    header.appendChild(leftHeader);
    header.appendChild(rightHeader);
    monthDiv.appendChild(header);

    // –ö–æ–Ω—Ç–µ–Ω—Ç –º–µ—Å—è—Ü–∞ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏)
    const monthContent = document.createElement('div');
    monthContent.className = 'month-content';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    monthContent.onclick = () => openMonthDetailModal(idx, label, dynamicLimit, monthTotal, mandatoryForMonth);
    monthContent.style.cursor = 'pointer';

    // Stats
    const stats = document.createElement('div');
    stats.className = 'month-stats';

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π –ø–ª–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    let planLabel = '–ü–ª–∞–Ω';
    let lastMonthWithExpenses = -1;
    for(let i = 0; i < monthlyActuals.length; i++){
      if(monthlyActuals[i] > 0) lastMonthWithExpenses = i;
    }
    
    if(idx === 0 && monthlyActuals[0] === 0){
      planLabel = '–ü–ª–∞–Ω (–±–∞–∑–æ–≤—ã–π)';
    } else if(idx <= lastMonthWithExpenses){
      planLabel = '–ü–ª–∞–Ω (–±–∞–∑–æ–≤—ã–π)';
    } else if(lastMonthWithExpenses >= 0){
      planLabel = '–ü–ª–∞–Ω (–ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç)';
    } else {
      planLabel = '–ü–ª–∞–Ω (–±–∞–∑–æ–≤—ã–π)';
    }
    const statPlanned = createStatItem(planLabel, fmt0(dynamicLimit));
    if(isNegativeLimit) statPlanned.style.color = '#ff4444';
    
    const statMandatory = createStatItem('–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ', fmt0(mandatoryForMonth));
    const statActual = createStatItem('–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', fmt0(monthTotal));
    if(isOverspent) statActual.style.color = '#ff4444';

    stats.appendChild(statPlanned);
    stats.appendChild(statMandatory);
    stats.appendChild(statActual);

    monthContent.appendChild(stats);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å–æ —Å—Ä–µ–¥–Ω–µ–π —Ç—Ä–∞—Ç–æ–π –∑–∞ –¥–µ–Ω—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ - –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø
    if(isCurrent && dailyAverage && dailyAverage.days > 0){
      const dailyAvgDiv = document.createElement('div');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∏–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
      let bgClass = 'daily-avg-normal';
      if(dailyAverage.status === 'good') bgClass = 'daily-avg-good';
      else if(dailyAverage.status === 'bad') bgClass = 'daily-avg-bad';
      
      dailyAvgDiv.className = bgClass;
      dailyAvgDiv.style.cssText = 'border-radius:8px; padding:10px; margin:10px 0; border: 1px solid;';
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π
      let valueClass = 'daily-avg-value';
      if(dailyAverage.status === 'good') valueClass += ' good';
      else if(dailyAverage.status === 'bad') valueClass += ' bad';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      let progressClass = 'progress-indicator normal';
      let progressText = Math.round(dailyAverage.percentage) + '%';
      if(dailyAverage.status === 'good') {
        progressClass = 'progress-indicator good';
        progressText = '‚úì ' + progressText;
      } else if(dailyAverage.status === 'bad') {
        progressClass = 'progress-indicator bad';
        progressText = '‚ö† ' + progressText;
      }
      
      dailyAvgDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:start;">
          <div style="flex: 1;">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">
              –°—Ä–µ–¥–Ω—è—è —Ç—Ä–∞—Ç–∞ –≤ –¥–µ–Ω—å
              <span class="${progressClass}">${progressText}</span>
            </div>
            <div style="font-size:16px; font-weight:700;" class="${valueClass}">
              ${fmt0(dailyAverage.average)}
              <span style="font-size:13px; font-weight:500; color:var(--muted); margin-left:4px;">
                (—Ä–µ–∫. ${fmt0(dailyAverage.recommendedDaily)})
              </span>
            </div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px;">
              –∑–∞ ${dailyAverage.days} ${dailyAverage.days === 1 ? '–¥–µ–Ω—å' : dailyAverage.days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:11px; color:var(--muted);">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</div>
            <div style="font-size:14px; font-weight:600; color:var(--text);">
              ${fmt0(dailyAverage.total)}
            </div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px;">
              —Ä–µ–∫. ${fmt0(dailyAverage.recommendedTotal)}
            </div>
          </div>
        </div>
      `;
      monthContent.appendChild(dailyAvgDiv);
    }
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –ª–∏–º–∏—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
    if(isNegativeLimit){
      const warning = document.createElement('div');
      warning.style.cssText = 'background:rgba(220,38,38,0.2);border:1px solid #dc2626;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;color:#ff8a8a;font-weight:600;';
      warning.textContent = '‚ö†Ô∏è –ë—é–¥–∂–µ—Ç –∏—Å—á–µ—Ä–ø–∞–Ω! –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–Ω–∞.';
      monthContent.appendChild(warning);
    }
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥–µ
    if(isOverspent && !isNegativeLimit){
      const warning = document.createElement('div');
      warning.style.cssText = 'background:rgba(255,138,138,0.1);border:1px solid #ff8a8a;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;color:#ff8a8a;';
      const overspentAmount = monthTotal - dynamicLimit;
      warning.innerHTML = `‚ö†Ô∏è –ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: ${fmt0(overspentAmount)}`;
      monthContent.appendChild(warning);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
    if(mandatoryForMonth > 0){
      const mandatoryInfo = document.createElement('div');
      mandatoryInfo.style.cssText = 'background:#1a1f37;border:1px solid #4338ca;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;';
      
      const paymentsForMonth = [];
      for(const payment of state.mandatoryPayments){
        const paymentDate = new Date(state.start.getFullYear(), state.start.getMonth() + idx, payment.dayOfMonth);
        if(paymentDate >= state.start && paymentDate <= state.end && paymentDate.getMonth() === (state.start.getMonth() + idx) % 12){
          paymentsForMonth.push(`${payment.name}: ${fmt0(payment.amount)} (${payment.dayOfMonth} —á–∏—Å–ª–∞)`);
        }
      }
      
      mandatoryInfo.innerHTML = `<div style="color:var(--purple);font-weight:600;margin-bottom:4px;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</div>${paymentsForMonth.join('<br>')}`;
      monthContent.appendChild(mandatoryInfo);
    }

    // Transactions list
    if(hasTransactions){
      const transList = document.createElement('div');
      transList.className = 'transactions';
      
      transactions.forEach((t, tIdx) => {
        const transDiv = document.createElement('div');
        transDiv.className = 'transaction';
        
        const leftDiv = document.createElement('div');
        leftDiv.innerHTML = `
          <div>${t.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
          <div class="date">${new Date(t.date).toLocaleDateString('ru-RU')}</div>
        `;
        
        const rightDiv = document.createElement('div');
        rightDiv.style.display = 'flex';
        rightDiv.style.gap = '8px';
        rightDiv.style.alignItems = 'center';
        
        const amountSpan = document.createElement('span');
        amountSpan.className = 'amount';
        amountSpan.textContent = fmt0(t.amount);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn ghost small';
        delBtn.textContent = '√ó';
        delBtn.style.padding = '2px 8px';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deleteTransaction(idx, tIdx);
        };
        
        rightDiv.appendChild(amountSpan);
        rightDiv.appendChild(delBtn);
        
        transDiv.appendChild(leftDiv);
        transDiv.appendChild(rightDiv);
        transList.appendChild(transDiv);
      });
      
      monthContent.appendChild(transList);
    }

    monthDiv.appendChild(monthContent);
    $monthsList.appendChild(monthDiv);
  });
}



    function createStatItem(label, value){
      const div = document.createElement('div');
      div.className = 'stat-item';
      div.innerHTML = `
        <div class="stat-label">${label}</div>
        <div class="stat-value">${value}</div>
      `;
      return div;
    }

    // ===========================
    // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
    // ===========================
    function openAddExpenseModal(monthIndex, monthLabel){
      state.currentModalMonth = monthIndex;
      document.getElementById('modalMonth').value = monthLabel;
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDesc').value = '';
      document.getElementById('addExpenseModal').classList.add('show');
      document.getElementById('expenseAmount').focus();
    }

    function closeModal(){
      document.getElementById('addExpenseModal').classList.remove('show');
      state.currentModalMonth = -1;
    }

    function saveExpense(){
      const amount = parseFloat(document.getElementById('expenseAmount').value.replace(',', '.'));
      const description = document.getElementById('expenseDesc').value.trim();
      
      if(!Number.isFinite(amount) || amount <= 0){
        document.getElementById('expenseAmount').focus();
        return;
      }
      
      if(state.currentModalMonth >= 0 && state.currentModalMonth < state.months){
        if(!state.monthlyTransactions[state.currentModalMonth]){
          state.monthlyTransactions[state.currentModalMonth] = [];
        }
        
        state.monthlyTransactions[state.currentModalMonth].push({
          amount,
          description: description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è',
          date: new Date().toISOString()
        });
        
        closeModal();
        recalcAll();
      }
    }

    function openMandatoryModal(){
      document.getElementById('mandatoryName').value = '';
      document.getElementById('mandatoryAmount').value = '';
      document.getElementById('mandatoryDay').value = '';
      document.getElementById('mandatoryModal').classList.add('show');
      document.getElementById('mandatoryName').focus();
    }

    function closeMandatoryModal(){
      document.getElementById('mandatoryModal').classList.remove('show');
    }

    function saveMandatory(){
      const name = document.getElementById('mandatoryName').value.trim();
      const amount = parseFloat(document.getElementById('mandatoryAmount').value.replace(',', '.'));
      const day = parseInt(document.getElementById('mandatoryDay').value);
      
      if(!name){
        document.getElementById('mandatoryName').focus();
        return;
      }
      
      if(!Number.isFinite(amount) || amount <= 0){
        document.getElementById('mandatoryAmount').focus();
        return;
      }
      
      if(!Number.isFinite(day) || day < 1 || day > 31){
        document.getElementById('mandatoryDay').focus();
        return;
      }
      
      state.mandatoryPayments.push({
        name,
        amount,
        dayOfMonth: day
      });
      
      closeMandatoryModal();
      recalcAll();
    }

    function deleteMandatory(index){
      if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂?')){
        state.mandatoryPayments.splice(index, 1);
        recalcAll();
      }
    }

        // ===========================
    // –î–ï–¢–ê–õ–¨–ù–´–ô –ü–†–û–°–ú–û–¢–† –ú–ï–°–Ø–¶–ê
    // ===========================
    function openMonthDetailModal(monthIndex, monthLabel, plannedAmount, actualSpent, mandatoryAmount){
      document.getElementById('monthDetailTitle').textContent = '–î–µ—Ç–∞–ª–∏: ' + monthLabel;
      
      // –†–∞—Å—á—ë—Ç—ã
      const available = Math.max(0, plannedAmount - actualSpent);
      const spentInPlan = Math.min(actualSpent, plannedAmount);
      const overspent = Math.max(0, actualSpent - plannedAmount);
      const balance = plannedAmount - actualSpent;
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ç—Ä–∞—Ç—É –∑–∞ –¥–µ–Ω—å
      const dailyAverage = calculateDailyAverage(monthIndex);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      document.getElementById('detailPlan').textContent = fmt0(plannedAmount);
      document.getElementById('detailMandatory').textContent = fmt0(mandatoryAmount);
      document.getElementById('detailActual').textContent = fmt0(actualSpent);
      
      const balanceEl = document.getElementById('detailBalance');
      balanceEl.textContent = fmt0(Math.abs(balance));
      balanceEl.className = 'detail-stat-value';
      if(balance < 0){
        balanceEl.classList.add('overspent');
        balanceEl.textContent = '‚àí' + fmt0(Math.abs(balance));
      } else {
        balanceEl.textContent = '+' + fmt0(balance);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Ç—Ä–∞—Ç—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
      const detailStatsDiv = document.querySelector('.detail-stats');
      const existingDailyAvg = document.getElementById('dailyAvgStat');
      if(existingDailyAvg) existingDailyAvg.remove();
      
      if(dailyAverage && dailyAverage.days > 0){
        const dailyAvgStat = document.createElement('div');
        dailyAvgStat.id = 'dailyAvgStat';
        dailyAvgStat.className = 'detail-stat';
        dailyAvgStat.style.gridColumn = 'span 2';
        dailyAvgStat.style.background = 'linear-gradient(135deg, rgba(109,211,251,.08), rgba(167,139,250,.08))';
        dailyAvgStat.style.border = '1px solid #4338ca';
        dailyAvgStat.innerHTML = `
          <div class="detail-stat-label">–°—Ä–µ–¥–Ω—è—è —Ç—Ä–∞—Ç–∞ –≤ –¥–µ–Ω—å (–∑–∞ ${dailyAverage.days} ${dailyAverage.days === 1 ? '–¥–µ–Ω—å' : dailyAverage.days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'})</div>
          <div class="detail-stat-value" style="color:var(--accent);">${fmt0(dailyAverage.average)}</div>
        `;
        detailStatsDiv.appendChild(dailyAvgStat);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
      document.getElementById('legendAvailable').textContent = fmt0(available);
      document.getElementById('legendSpent').textContent = fmt0(spentInPlan);
      
      const overspentLegend = document.getElementById('overspentLegend');
      if(overspent > 0){
        overspentLegend.style.display = 'flex';
        document.getElementById('legendOverspent').textContent = fmt0(overspent);
      } else {
        overspentLegend.style.display = 'none';
      }
      
      // –†–∏—Å—É–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
      drawPieChart(plannedAmount, actualSpent);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      document.getElementById('monthDetailModal').classList.add('show');
    }
    
    function closeMonthDetailModal(){
      document.getElementById('monthDetailModal').classList.remove('show');
    }
    
    function drawPieChart(planned, spent){
      const canvas = document.getElementById('pieChart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;
      
      // –û—á–∏—â–∞–µ–º canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–ª—ã
      const total = Math.max(planned, spent);
      if(total <= 0) return;
      
      const spentInPlan = Math.min(spent, planned);
      const overspent = Math.max(0, spent - planned);
      const available = Math.max(0, planned - spent);
      
      // –ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª (—Å–≤–µ—Ä—Ö—É)
      let currentAngle = -Math.PI / 2;
      
      // –†–∏—Å—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é —á–∞—Å—Ç—å (–∑–µ–ª—ë–Ω—ã–π)
      if(available > 0){
        const availableAngle = (available / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + availableAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#4ade80';
        ctx.fill();
        currentAngle += availableAngle;
      }
      
      // –†–∏—Å—É–µ–º –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—É—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–ª–∞–Ω–∞ —á–∞—Å—Ç—å (–∫—Ä–∞—Å–Ω—ã–π)
      if(spentInPlan > 0){
        const spentAngle = (spentInPlan / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + spentAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#ff8a8a';
        ctx.fill();
        currentAngle += spentAngle;
      }
      
      // –†–∏—Å—É–µ–º –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ (–∞–ª—ã–π)
      if(overspent > 0){
        const overspentAngle = (overspent / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + overspentAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#ff4444';
        ctx.fill();
      }
      
      // –†–∏—Å—É–µ–º –±–µ–ª—É—é –æ–±–≤–æ–¥–∫—É
      ctx.strokeStyle = '#27305a';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ
      ctx.fillStyle = '#e8ecff';
      ctx.font = 'bold 14px Inter, system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const percentage = planned > 0 ? Math.round((spent / planned) * 100) : 0;
      ctx.fillText(percentage + '%', centerX, centerY - 10);
      ctx.font = '12px Inter, system-ui, sans-serif';
      ctx.fillStyle = '#8e97b3';
      ctx.fillText('–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ', centerX, centerY + 10);
    }


    function deleteTransaction(monthIndex, transactionIndex){
      if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞—Ç—É?')){
        state.monthlyTransactions[monthIndex].splice(transactionIndex, 1);
        recalcAll();
      }
    }

    // ===========================
    // –ì–†–ê–§–ò–ö
    // ===========================
    function drawChart(labels, planned, actual, forecast){
      const w = $chart.width, h = $chart.height;
      ctx.clearRect(0,0,w,h);

      const padL = 60, padR = 16, padT = 14, padB = 38;
      const gw = w - padL - padR;
      const gh = h - padT - padB;

      const ys = []
        .concat(Array.isArray(planned)?planned:[])
        .concat(Array.isArray(actual)?actual:[])
        .concat(Array.isArray(forecast)?forecast:[])
        .filter(Number.isFinite);

      if(ys.length === 0){
        drawGrid(padL, padT, gw, gh, 4, 4);
        return;
      }

      let yMin = Math.min(...ys), yMax = Math.max(...ys);
      const pad = Math.max(1000, (yMax - yMin)*0.08);
      yMin -= pad; yMax += pad;
      if(yMax === yMin){ yMax += 1; yMin -= 1; }

      drawGrid(padL, padT, gw, gh, 5, labels.length || 4);
      drawYTicks(padL, padT, gw, gh, yMin, yMax, 5);
      drawXLabels(labels, padL, padT, gw, gh);

      const X = (i, totalPoints)=>{
        const t = totalPoints === 0 ? 0 : i / totalPoints;
        return padL + t * gw;
      };
      const Y = (val)=>{
        const t = (val - yMin) / (yMax - yMin);
        return padT + (1 - t) * gh;
      };

      // –ü–ª–∞–Ω
      if(planned && planned.length){
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line1').trim();
        ctx.beginPath();
        for(let i=0;i<planned.length;i++){
          const x = X(i, planned.length-1), y = Y(planned[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π
      if(actual && actual.length){
        ctx.lineWidth = 3;
        ctx.setLineDash([]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line2').trim();
        ctx.beginPath();
        for(let i=0;i<actual.length;i++){
          const x = X(i, (planned?.length||1)-1), y = Y(actual[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        
        // –¢–æ—á–∫–∏
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--line2').trim();
        for(let i=0;i<actual.length;i++){
          const x = X(i, (planned?.length||1)-1), y = Y(actual[i]);
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // –ü—Ä–æ–≥–Ω–æ–∑
      if(forecast && forecast.length){
        ctx.lineWidth = 2;
        ctx.setLineDash([8,4]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line3').trim();
        ctx.beginPath();
        const totalPoints = (planned?.length||1)-1;
        const startIndex = (actual?.length||1)-1;
        for(let i=0;i<forecast.length;i++){
          const x = X(startIndex + i, totalPoints);
          const y = Y(forecast[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    function drawGrid(x, y, w, h, rows, cols){
      ctx.save();
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.3;

      for(let c=0;c<=cols;c++){
        const xx = x + (w * c/cols);
        ctx.beginPath();
        ctx.moveTo(xx, y);
        ctx.lineTo(xx, y+h);
        ctx.stroke();
      }
      for(let r=0;r<=rows;r++){
        const yy = y + (h * r/rows);
        ctx.beginPath();
        ctx.moveTo(x, yy);
        ctx.lineTo(x+w, yy);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawYTicks(x, y, w, h, vmin, vmax, rows){
      ctx.save();
      ctx.fillStyle = '#8e97b3';
      ctx.font = '11px system-ui, sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for(let r=0;r<=rows;r++){
        const t = r/rows;
        const yy = y + (h * t);
        const val = vmax - (vmax - vmin)*t;
        const label = fmtShort(val) + ' ‚ÇΩ';
        ctx.fillText(label, x - 8, yy);
      }
      ctx.restore();
    }

    function drawXLabels(labels, x, y, w, h){
      if(!labels || !labels.length) return;
      ctx.save();
      ctx.fillStyle = '#8e97b3';
      ctx.font = '11px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      const total = labels.length-1;
      for(let i=0;i<labels.length;i++){
        const xx = x + (w * (i/total||0));
        const shortLabel = labels[i].slice(0, 3);
        ctx.fillText(shortLabel, xx, y + h + 8);
      }
      ctx.restore();
    }

    // ===========================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
    // ===========================
    $calcBtn.addEventListener('click', recalcAll);
    $resetBtn.addEventListener('click', () => {
      $initial.value = '';
      $target.value = '';
      $start.value = '';
      $end.value = '';
      Object.assign(state, {
        initial:0,
        target:0,
        start:null,
        end:null,
        months:0,
        mandatoryPayments:[],
        monthlyTransactions:[],
        labels:[],
        collapsedMonths:{} // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
      });
      localStorage.removeItem(STORAGE_KEY);
      recalcAll();
    });

    $start.addEventListener('change', recalcAll);
    $end.addEventListener('change', recalcAll);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
    document.getElementById('addExpenseModal').addEventListener('click', (e) => {
      if(e.target.id === 'addExpenseModal'){
        closeModal();
      }
    });
    
    document.getElementById('mandatoryModal').addEventListener('click', (e) => {
      if(e.target.id === 'mandatoryModal'){
        closeMandatoryModal();
      }
    });

        document.getElementById('monthDetailModal').addEventListener('click', (e) => {
      if(e.target.id === 'monthDetailModal'){
        closeMonthDetailModal();
      }
    });


    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        closeModal();
        closeMandatoryModal();
        closeMonthDetailModal();
      }
    });

    // ===========================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ===========================
    (function init(){
      loadState();
      
      if(state.initial) $initial.value = String(state.initial);
      if(state.target) $target.value = String(state.target);
      if(state.start) $start.valueAsDate = state.start;
      if(state.end) $end.valueAsDate = state.end;

      recalcAll();

      // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –ø—É—Å—Ç–æ
      if(!state.start && !state.end && !$initial.value && !$target.value){
        $initial.value = '150000';
        $target.value = '30000';
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        const end = new Date(today.getFullYear(), today.getMonth() + 3, 0);
        $start.valueAsDate = start;
        $end.valueAsDate = end;
        
        // –î–µ–º–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
        state.mandatoryPayments = [
          {name: '–ê—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã', amount: 25000, dayOfMonth: 5},
          {name: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', amount: 800, dayOfMonth: 10}
        ];
        
        recalcAll();
      }
    })();
  </script>
</body>
</html>
