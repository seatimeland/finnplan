<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Финансовый Планер — прототип</title>
  <style>
    :root{
      --bg:#0f1220;
      --card:#171b2e;
      --muted:#8e97b3;
      --text:#e8ecff;
      --accent:#6dd3fb;
      --accent2:#22d3ee;
      --warn:#ff8a8a;
      --ok:#86efac;
      --line1:#7aa2ff;
      --line2:#ffb86b;
      --line3:#4ade80;
      --grid:#2a3050;
      --purple:#a78bfa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1a1f37 0%, #0f1220 60%) no-repeat fixed, var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    #app{
      max-width:1200px;
      margin:32px auto 80px;
      padding:0 16px;
    }
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted); margin-bottom:24px}
    .grid{
      display:grid;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{
        grid-template-columns: 1.1fr 1fr;
        align-items:start;
      }
    }
    section{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      border:1px solid #242a47;
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
    }
    section h2{
      margin:0 0 12px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }
    label{
      font-size:13px;
      color:var(--muted);
    }
    input, button, select{
      background:#0f1326;
      color:var(--text);
      border:1px solid #283158;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      transition:.15s border-color ease;
    }
    input:focus, select:focus{border-color:#3f5bd6}
    input[type="date"]{padding:9px 10px}
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .btn{
      background:linear-gradient(180deg, #3f5bd6, #334ec0);
      border:none;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      transition: transform 0.1s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{
      background:transparent;
      border:1px solid #334ec0;
    }
    .btn.accent{
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      color:#0f1220;
    }
    .btn.small{
      padding:6px 10px;
      font-size:13px;
    }
    .btn.icon{
      padding:8px;
      min-width:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.danger{
      background:linear-gradient(180deg, #dc2626, #b91c1c);
    }
    .note{
      font-size:13px;
      color:var(--muted);
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin:8px 0 4px;
    }
    @media (min-width:680px){
      .kpi{grid-template-columns: repeat(4, minmax(0,1fr));}
    }
    .tile{
      background: #0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .tile.highlight{
      background: linear-gradient(135deg, rgba(167,139,250,.06), rgba(109,211,251,.06));
      border-color:#4338ca;
    }
    .tile .label{font-size:12px;color:var(--muted)}
    .tile .value{font-size:18px;font-weight:700;margin-top:4px}
    .tile.warn{border-color:#4e1e2a;background:rgba(255,72,72,.06)}
    .tile.ok{border-color:#2d4a38;background:rgba(61, 194, 124, .06)}
    .warn-text{color:var(--warn); font-weight:600}
    .ok-text{color:var(--ok); font-weight:600}
    .divider{height:1px;background:#27305a;margin:14px 0}
    #chartWrap{
      background:#0d1122;
      border:1px solid #27305a;
      border-radius:12px;
      padding:10px;
    }
    canvas{width:100%; height:320px; display:block}
    .months{
      display:flex; flex-direction:column; gap:10px; margin-top:8px;
    }
    .month{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:12px;
      position:relative;
    }
    .month.current{
      border-color:#4338ca;
      background: linear-gradient(135deg, rgba(167,139,250,.03), rgba(109,211,251,.03));
    }
    .month-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .month-name{
      font-weight:600;
      font-size:15px;
    }
    .month-stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      margin-bottom:10px;
    }
    .stat-item{
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:8px;
      text-align:center;
    }
    .stat-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .stat-value{
      font-size:14px;
      font-weight:600;
    }
    .month-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .transactions{
      margin-top:10px;
      max-height:200px;
      overflow-y:auto;
    }
    .transaction{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 8px;
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:6px;
      margin-bottom:4px;
      font-size:13px;
    }
    .transaction .amount{
      font-weight:600;
      color:var(--warn);
    }
    .transaction .date{
      color:var(--muted);
      font-size:11px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid #27305a; padding:6px 10px; border-radius:999px; 
      font-size:12px; color:var(--muted);
    }
    .pill.accent{
      background:rgba(109,211,251,.1);
      border-color:var(--accent);
      color:var(--accent);
    }
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 0}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.plan{background:var(--line1)}
    .dot.actual{background:var(--line2)}
    .dot.forecast{background:var(--line3)}
    .footer-note{margin-top:14px; font-size:12px; color:var(--muted)}
    .right{justify-self:end}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    
    /* Modal */
    .modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      opacity:0;
      visibility:hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .modal.show{
      opacity:1;
      visibility:visible;
    }
    .modal-content{
      background:var(--card);
      border:1px solid #27305a;
      border-radius:16px;
      padding:24px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .modal-title{
      font-size:18px;
      font-weight:700;
    }
    .modal-close{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:20px;
      cursor:pointer;
      padding:0;
      width:28px;
      height:28px;
    }
    .modal-close:hover{color:var(--text)}
    
    /* Mandatory Payments */
    .mandatory-section{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:12px;
      padding:14px;
      margin-bottom:14px;
    }
    .mandatory-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .mandatory-title{
      font-size:15px;
      font-weight:600;
    }
    .mandatory-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .mandatory-item{
      background:#0b0f1e;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .mandatory-info{
      flex:1;
    }
    .mandatory-name{
      font-size:14px;
      font-weight:500;
      margin-bottom:2px;
    }
    .mandatory-details{
      font-size:12px;
      color:var(--muted);
    }
    .mandatory-amount{
      font-size:16px;
      font-weight:700;
      color:var(--purple);
      margin-right:10px;
    }
    
    /* Recommendations */
    .recommendations{
      background: linear-gradient(135deg, rgba(167,139,250,.08), rgba(109,211,251,.08));
      border:1px solid #4338ca;
      border-radius:12px;
      padding:14px;
      margin-top:12px;
    }
    .rec-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:10px;
      color:var(--purple);
    }
    .rec-grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:10px;
    }
    @media (min-width:600px){
      .rec-grid{grid-template-columns: repeat(3,1fr);}
    }
    .rec-item{
      background:#0f1326;
      border:1px solid #27305a;
      border-radius:8px;
      padding:10px;
      text-align:center;
    }
    .rec-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .rec-value{
      font-size:16px;
      font-weight:700;
      color:var(--accent);
    }
    
    .badge{
      background:var(--accent);
      color:#0f1220;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:700;
      margin-left:6px;
    }
    
    .input-group{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .input-group .field{
      flex:1;
    }
    .input-group .btn{
      margin-bottom:10px;
    }

        /* Стили для детального просмотра месяца */
    .month{
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .month:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,.3);
    }
    
    #monthDetailModal .modal-content{
      max-width: 600px;
    }
    
    .month-detail-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .month-detail-title{
      font-size: 20px;
      font-weight: 700;
    }
    
    .pie-chart-container{
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      position: relative;
    }
    
    #pieChart{
      max-width: 280px;
      max-height: 280px;
    }
    
    .chart-legend{
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
    }
    
    .legend-item{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .legend-color{
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    
    .detail-stats{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .detail-stat{
      background: #0f1326;
      border: 1px solid #27305a;
      border-radius: 10px;
      padding: 12px;
    }
    
    .detail-stat-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .detail-stat-value{
      font-size: 18px;
      font-weight: 700;
    }
    
    .overspent{
      color: #ff4444;
    }

    /* Стили для сворачивания месяцев */
    .month-toggle-btn {
      background: transparent;
      border: 1px solid #27305a;
      color: var(--muted);
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .month-toggle-btn:hover {
      background: rgba(109,211,251,.1);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .month.collapsed .month-content {
      display: none;
    }
    
    .month.collapsed {
      padding: 10px 12px;
    }
    
    .month.collapsed .month-header {
      margin-bottom: 0;
    }
    
    .month-toggle-btn.collapsed {
      transform: rotate(-90deg);
    }
    /* Стили для индикации средней траты */
.daily-avg-good {
  background: linear-gradient(135deg, rgba(134,239,172,.12), rgba(74,222,128,.12)) !important;
  border-color: #4ade80 !important;
}

.daily-avg-normal {
  background: linear-gradient(135deg, rgba(109,211,251,.08), rgba(167,139,250,.08)) !important;
  border-color: #4338ca !important;
}

.daily-avg-bad {
  background: linear-gradient(135deg, rgba(255,138,138,.12), rgba(255,68,68,.12)) !important;
  border-color: #ff4444 !important;
}

.daily-avg-value.good {
  color: #4ade80 !important;
}

.daily-avg-value.bad {
  color: #ff8a8a !important;
}

.progress-indicator {
  display: inline-block;
  margin-left: 8px;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
}

.progress-indicator.good {
  background: rgba(134,239,172,.2);
  color: #4ade80;
}

.progress-indicator.normal {
  background: rgba(109,211,251,.2);
  color: var(--accent);
}

.progress-indicator.bad {
  background: rgba(255,138,138,.2);
  color: #ff8a8a;
}
    
    

  </style>
</head>
<body>
  <div id="app">
    <h1>Финансовый Планер</h1>
    <div class="sub">Наведи порядок в тратах и уверенно двигайся к цели. Заполни поля, добавь обязательные платежи с датами оплаты и смотри, как меняется доступный лимит.</div>

    <div class="grid">
      <!-- ВВОД ДАННЫХ -->
      <section id="input-section">
        <h2>Ваш план</h2>

        <div class="field">
          <label for="initial">Начальный капитал, ₽</label>
          <input id="initial" type="number" inputmode="decimal" min="0" step="100" placeholder="например, 100000" />
        </div>

        <div class="field">
          <label for="target">Целевой баланс к концу периода, ₽</label>
          <input id="target" type="number" inputmode="decimal" min="0" step="100" placeholder="например, 50000" />
        </div>

        <div class="row">
          <div class="field">
            <label for="start">Начальная дата</label>
            <input id="start" type="date" />
          </div>
          <div class="field">
            <label for="end">Конечная дата</label>
            <input id="end" type="date" />
          </div>
        </div>

        <!-- Обязательные платежи -->
        <div class="mandatory-section">
          <div class="mandatory-header">
            <div class="mandatory-title">Обязательные платежи</div>
            <button class="btn accent small" onclick="openMandatoryModal()">+ Добавить</button>
          </div>
          <div id="mandatoryList" class="mandatory-list">
            <div class="note">Нет обязательных платежей</div>
          </div>
        </div>

        <div class="actions">
          <button id="calcBtn" class="btn">Рассчитать</button>
          <button id="resetBtn" class="btn ghost">Сбросить</button>
          <span class="pill" id="monthsInfo">Месяцев: —</span>
        </div>
        <div class="note">Обязательные платежи учитываются только если дата оплаты попадает в период планирования.</div>
      </section>

      <!-- РЕЗУЛЬТАТЫ И ГРАФИК -->
      <section id="results-section">
        <h2>Результаты</h2>

        <div class="kpi">
          <div class="tile">
            <div class="label">Доступно для трат за период</div>
            <div class="value" id="availableTotal">—</div>
            <div class="small">После вычета обязательных</div>
          </div>

          <div class="tile" id="limitTile">
            <div class="label">Лимит трат в месяц (базовый)</div>
            <div class="value" id="monthlyLimit">—</div>
            <div class="small">Без учёта фактических</div>
          </div>

          <div class="tile">
            <div class="label">Обязательные платежи за период</div>
            <div class="value" id="mandatoryTotal">—</div>
          </div>

          <div class="tile" id="feasibilityTile">
            <div class="label">Состояние плана</div>
            <div class="value" id="feasibility">—</div>
          </div>
        </div>

        <!-- Рекомендации -->
        <div id="recommendationsBlock" class="recommendations hidden">
          <div class="rec-title">💡 Рекомендуемые лимиты</div>
          <div class="rec-grid">
            <div class="rec-item">
              <div class="rec-label">В день</div>
              <div class="rec-value" id="dailyLimit">—</div>
            </div>
            <div class="rec-item">
              <div class="rec-label">В неделю</div>
              <div class="rec-value" id="weeklyLimit">—</div>
            </div>
            <div class="rec-item">
              <div class="rec-label">В 10 дней</div>
              <div class="rec-value" id="tenDaysLimit">—</div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="chartWrap">
          <canvas id="chart" width="1000" height="360"></canvas>
          <div class="legend">
            <span class="pill"><span class="dot plan"></span> План по балансу</span>
            <span class="pill"><span class="dot actual"></span> Фактический баланс</span>
            <span class="pill"><span class="dot forecast"></span> Прогноз до конца</span>
          </div>
        </div>
      </section>
    </div>

    <!-- ФАКТИЧЕСКИЕ ТРАТЫ -->
    <section id="actual-spending-section">
      <h2>Фактические траты по месяцам</h2>
      <div class="note">Добавляй расходы через кнопку "+" для каждого месяца. Обязательные платежи отображаются автоматически.</div>
      
      <div id="monthsList" class="months"></div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="tile">
          <div class="label">Учтено месяцев</div>
          <div class="value" id="countSaved">—</div>
        </div>
        <div class="tile">
          <div class="label">Сумма фактических трат</div>
          <div class="value" id="sumActual">—</div>
        </div>
        <div class="tile">
          <div class="label">Осталось на период</div>
          <div class="value" id="remainingTotal">—</div>
        </div>
        <div class="tile highlight" id="newLimitTile">
          <div class="label">Новый лимит в месяц</div>
          <div class="value" id="newMonthlyLimit">—</div>
          <div class="small">С учётом фактических трат</div>
        </div>
      </div>

      <div id="unfeasibleMsg" class="tile warn hidden" style="margin-top:10px;">
        <div class="label warn-text">Предупреждение</div>
        <div class="value" style="font-size:16px;font-weight:600;">
          План невыполним. Увеличьте период или уменьшите обязательные платежи.
        </div>
      </div>
    </section>
  </div>

  <!-- Модальное окно для добавления траты -->
  <div id="addExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Добавить расход</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="field">
        <label>Месяц</label>
        <input type="text" id="modalMonth" readonly style="background:#0b0f1e;">
      </div>
      <div class="field">
        <label for="expenseAmount">Сумма расхода, ₽</label>
        <input type="number" id="expenseAmount" inputmode="decimal" min="0" step="100" placeholder="например, 5000">
      </div>
      <div class="field">
        <label for="expenseDesc">Описание (необязательно)</label>
        <input type="text" id="expenseDesc" placeholder="например, Продукты">
      </div>
      <div class="actions">
        <button class="btn accent" onclick="saveExpense()">Добавить</button>
        <button class="btn ghost" onclick="closeModal()">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для обязательных платежей -->
  <div id="mandatoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Добавить обязательный платеж</h3>
        <button class="modal-close" onclick="closeMandatoryModal()">×</button>
      </div>
      <div class="field">
        <label for="mandatoryName">Название платежа</label>
        <input type="text" id="mandatoryName" placeholder="например, Аренда квартиры">
      </div>
      <div class="field">
        <label for="mandatoryAmount">Сумма платежа, ₽</label>
        <input type="number" id="mandatoryAmount" inputmode="decimal" min="0" step="100" placeholder="например, 30000">
      </div>
      <div class="field">
        <label for="mandatoryDay">День месяца для оплаты (1-31)</label>
        <input type="number" id="mandatoryDay" min="1" max="31" placeholder="например, 5">
        <small class="note">Платеж будет учитываться только в месяцах, где эта дата попадает в период планирования</small>
      </div>
      <div class="actions">
        <button class="btn accent" onclick="saveMandatory()">Добавить</button>
        <button class="btn ghost" onclick="closeMandatoryModal()">Отмена</button>
      </div>
    </div>
  </div>

    <!-- Модальное окно детального просмотра месяца -->
  <div id="monthDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="monthDetailTitle">Детали месяца</h3>
        <button class="modal-close" onclick="closeMonthDetailModal()">×</button>
      </div>
      
      <div class="pie-chart-container">
        <canvas id="pieChart" width="280" height="280"></canvas>
      </div>
      
      <div class="chart-legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #4ade80;"></div>
          <span>Доступно для трат</span>
          <span id="legendAvailable" style="margin-left:auto; font-weight:600;">—</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ff8a8a;"></div>
          <span>Потрачено (в пределах плана)</span>
          <span id="legendSpent" style="margin-left:auto; font-weight:600;">—</span>
        </div>
        <div class="legend-item" id="overspentLegend" style="display:none;">
          <div class="legend-color" style="background: #ff4444;"></div>
          <span>Перерасход</span>
          <span id="legendOverspent" style="margin-left:auto; font-weight:600; color:#ff4444;">—</span>
        </div>
      </div>
      
      <div class="detail-stats">
        <div class="detail-stat">
          <div class="detail-stat-label">План на месяц</div>
          <div class="detail-stat-value" id="detailPlan">—</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Обязательные платежи</div>
          <div class="detail-stat-value" id="detailMandatory">—</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Фактически потрачено</div>
          <div class="detail-stat-value" id="detailActual">—</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Остаток/Перерасход</div>
          <div class="detail-stat-value" id="detailBalance">—</div>
        </div>
      </div>
      
      <div class="actions" style="margin-top: 20px;">
        <button class="btn ghost" onclick="closeMonthDetailModal()">Закрыть</button>
      </div>
    </div>
  </div>


  <script>
    // ===========================
    // УТИЛИТЫ
    // ===========================
    const fmt = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'RUB', maximumFractionDigits:0 });
    const fmt0 = (n)=> n===null || Number.isNaN(n) ? '—' : fmt.format(n);
    const fmtShort = (n)=> {
      if(!Number.isFinite(n)) return '—';
      if(n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if(n >= 1000) return (n/1000).toFixed(1) + 'K';
      return Math.round(n).toString();
    };

    function num(el){
      const v = parseFloat(el.value.replace(',', '.'));
      return Number.isFinite(v) ? v : 0;
    }

    function monthsDiffCeil(start, end){
      if(!start || !end) return 0;
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      if(e <= s) return 0;
      let diff = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth());
      if(e.getDate() > s.getDate()) diff += 1;
      return diff;
    }

    function monthLabels(start, months){
      const labels = [];
      for(let i=0;i<months;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
        const label = d.toLocaleDateString('ru-RU', { month:'long', year:'numeric' });
        labels.push(capitalize(label));
      }
      return labels;
    }
    
    function capitalize(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

    function isCurrentMonth(monthIndex){
      if(!state.start) return false;
      const now = new Date();
      const monthDate = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
      return now.getFullYear() === monthDate.getFullYear() && now.getMonth() === monthDate.getMonth();
    }

    // ===========================
    // СОСТОЯНИЕ ПРИЛОЖЕНИЯ
    // ===========================
    const state = {
      initial: 0,
      target: 0,
      start: null,
      end: null,
      months: 0,
      mandatoryPayments: [], // Массив обязательных платежей [{name, amount, dayOfMonth}]
      monthlyTransactions: [], // Массив массивов транзакций по месяцам
      labels: [],
      currentModalMonth: -1,
      collapsedMonths: {} // Добавьте эту строку для хранения состояния сворачивания
    };

    // Локальное хранилище
    const STORAGE_KEY = 'finplanner_state_v3';
    function saveState(){
      try{
        const payload = {
          ...state,
          start: state.start ? state.start.toISOString() : null,
          end: state.end ? state.end.toISOString() : null,
          collapsedMonths: state.collapsedMonths // Добавьте эту строку
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){}
    }
    
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        state.initial = obj.initial ?? 0;
        state.target = obj.target ?? 0;
        state.start = obj.start ? new Date(obj.start) : null;
        state.end = obj.end ? new Date(obj.end) : null;
        state.months = obj.months ?? 0;
        state.mandatoryPayments = obj.mandatoryPayments ?? [];
        state.monthlyTransactions = obj.monthlyTransactions ?? [];
        state.labels = obj.labels ?? [];
        state.collapsedMonths = obj.collapsedMonths ?? {}; // Добавьте эту строку
      }catch(e){}
    }

    // ===========================
    // РАСЧЕТ ОБЯЗАТЕЛЬНЫХ ПЛАТЕЖЕЙ
    // ===========================
    function calculateMandatoryForMonth(monthIndex){
      if(!state.start || !state.end) return 0;
      
      const monthStart = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
      const monthEnd = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex + 1, 0);
      
      let total = 0;
      
      for(const payment of state.mandatoryPayments){
        const paymentDate = new Date(monthStart.getFullYear(), monthStart.getMonth(), payment.dayOfMonth);
        
        // Проверяем, что дата платежа попадает в период планирования
        if(paymentDate >= state.start && paymentDate <= state.end){
          // И что дата существует в этом месяце
          if(paymentDate.getMonth() === monthStart.getMonth()){
            total += payment.amount;
          }
        }
      }
      
      return total;
    }

    function calculateTotalMandatory(){
      let total = 0;
      for(let i = 0; i < state.months; i++){
        total += calculateMandatoryForMonth(i);
      }
      return total;
    }

    function calculateTotalMandatory(){
      let total = 0;
      for(let i = 0; i < state.months; i++){
        total += calculateMandatoryForMonth(i);
      }
      return total;
    }

     // ===========================
    // РАСЧЕТ ДИНАМИЧЕСКИХ ЛИМИТОВ
    // ===========================
    function calculateDynamicLimitForMonth(monthIndex, baseMonthlyLimit, monthlyActuals){
      // Для первого месяца возвращаем базовый лимит если в нем еще нет трат
      if(monthIndex === 0 && monthlyActuals[0] === 0){
        return baseMonthlyLimit;
      }
      
      // Находим последний месяц с тратами
      let lastMonthWithExpenses = -1;
      for(let i = 0; i < monthlyActuals.length; i++){
        if(monthlyActuals[i] > 0){
          lastMonthWithExpenses = i;
        }
      }
      
      // Если текущий месяц уже имеет траты или это прошедший месяц - показываем базовый план
      if(monthIndex <= lastMonthWithExpenses){
        return baseMonthlyLimit;
      }
      
      // Для будущих месяцев пересчитываем план
      // Считаем сколько уже потрачено (включая обязательные)
      let totalSpentSoFar = 0;
      for(let i = 0; i <= lastMonthWithExpenses; i++){
        totalSpentSoFar += monthlyActuals[i] + calculateMandatoryForMonth(i);
      }
      
      // Считаем сколько осталось обязательных платежей в будущих месяцах
      let futureMandatory = 0;
      for(let i = lastMonthWithExpenses + 1; i < state.months; i++){
        futureMandatory += calculateMandatoryForMonth(i);
      }
      
      // Общая доступная сумма за весь период
      const totalAvailableForPeriod = (state.initial - state.target) - calculateTotalMandatory();
      
      // Сколько осталось после фактических трат (без учета обязательных, так как они уже вычтены из totalAvailableForPeriod)
      const actualSpentWithoutMandatory = monthlyActuals.reduce((sum, v) => sum + v, 0);
      const remainingAfterActual = totalAvailableForPeriod - actualSpentWithoutMandatory;
      
      // Количество оставшихся месяцев (после последнего месяца с тратами)
      const remainingMonths = state.months - lastMonthWithExpenses - 1;
      
      // Новый равномерный лимит для всех оставшихся месяцев
      if(remainingMonths > 0){
        return remainingAfterActual / remainingMonths;
      }
      
      return 0;
    }

    // ===========================
    // РАСЧЕТ СРЕДНЕЙ ТРАТЫ ЗА ДЕНЬ
    // ===========================
    function calculateDailyAverage(monthIndex, dynamicLimit) {
  if (!state.start || !state.end) return null;
  if (!isCurrentMonth(monthIndex)) return null;
  
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  // Границы месяца
  const monthStart = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex, 1);
  const monthEnd = new Date(state.start.getFullYear(), state.start.getMonth() + monthIndex + 1, 0);
  
  // Определяем начало отсчета
  let countStart;
  if (monthIndex === 0) {
    // Для первого месяца берем дату начала плана
    countStart = new Date(state.start.getFullYear(), state.start.getMonth(), state.start.getDate());
  } else {
    // Для остальных месяцев - первое число
    countStart = monthStart;
  }
  
  // Определяем конец отсчета (минимум из: сегодня, конец месяца, конец плана)
  let countEnd = today;
  if (monthEnd < countEnd) countEnd = monthEnd;
  if (state.end < countEnd) countEnd = state.end;
  
  // Проверяем, что интервал валидный
  if (countEnd < countStart) return null;
  
  // Считаем количество дней (включительно)
  const daysCount = Math.floor((countEnd - countStart) / (1000 * 60 * 60 * 24)) + 1;
  
  // Получаем транзакции текущего месяца
  const transactions = state.monthlyTransactions[monthIndex] || [];
  
  // Считаем сумму трат за период
  let totalSpent = 0;
  transactions.forEach(t => {
    const transDate = new Date(t.date);
    const transDateOnly = new Date(transDate.getFullYear(), transDate.getMonth(), transDate.getDate());
    if (transDateOnly >= countStart && transDateOnly <= countEnd) {
      totalSpent += t.amount || 0;
    }
  });
  
  const dailyAvg = totalSpent / daysCount;
  
  // Рассчитываем рекомендуемый лимит
  const recommendedDailyLimit = dynamicLimit / 30; // Примерно 30 дней в месяце
  const recommendedTotalForDays = recommendedDailyLimit * daysCount;
  
  // Определяем статус (хорошо/нормально/плохо)
  const percentage = (totalSpent / recommendedTotalForDays) * 100;
  let status = 'normal';
  if (percentage < 90) status = 'good';
  else if (percentage > 110) status = 'bad';
  
  return {
    average: dailyAvg,
    days: daysCount,
    total: totalSpent,
    recommendedDaily: recommendedDailyLimit,
    recommendedTotal: recommendedTotalForDays,
    percentage: percentage,
    status: status
  };
}


    // ===========================
    // УПРАВЛЕНИЕ СВОРАЧИВАНИЕМ МЕСЯЦЕВ
    // ===========================
    function toggleMonth(monthIndex) {
      const monthId = `month_${monthIndex}`;
      state.collapsedMonths[monthId] = !state.collapsedMonths[monthId];
      saveState();
      
      const monthDiv = document.querySelector(`[data-month-index="${monthIndex}"]`);
      if (monthDiv) {
        if (state.collapsedMonths[monthId]) {
          monthDiv.classList.add('collapsed');
        } else {
          monthDiv.classList.remove('collapsed');
        }
        
        const toggleBtn = monthDiv.querySelector('.month-toggle-btn');
        if (toggleBtn) {
          if (state.collapsedMonths[monthId]) {
            toggleBtn.classList.add('collapsed');
          } else {
            toggleBtn.classList.remove('collapsed');
          }
        }
      }
    }

    // ===========================
    // DOM ЭЛЕМЕНТЫ
    // ===========================
    const $initial = document.getElementById('initial');
    const $target = document.getElementById('target');
    const $start = document.getElementById('start');
    const $end = document.getElementById('end');
    const $calcBtn = document.getElementById('calcBtn');
    const $resetBtn = document.getElementById('resetBtn');
    const $monthsInfo = document.getElementById('monthsInfo');
    const $availableTotal = document.getElementById('availableTotal');
    const $monthlyLimit = document.getElementById('monthlyLimit');
    const $mandatoryTotal = document.getElementById('mandatoryTotal');
    const $feasibility = document.getElementById('feasibility');
    const $limitTile = document.getElementById('limitTile');
    const $feasibilityTile = document.getElementById('feasibilityTile');
    const $monthsList = document.getElementById('monthsList');
    const $countSaved = document.getElementById('countSaved');
    const $sumActual = document.getElementById('sumActual');
    const $remainingTotal = document.getElementById('remainingTotal');
    const $newMonthlyLimit = document.getElementById('newMonthlyLimit');
    const $newLimitTile = document.getElementById('newLimitTile');
    const $unfeasibleMsg = document.getElementById('unfeasibleMsg');
    const $recommendationsBlock = document.getElementById('recommendationsBlock');
    const $dailyLimit = document.getElementById('dailyLimit');
    const $weeklyLimit = document.getElementById('weeklyLimit');
    const $tenDaysLimit = document.getElementById('tenDaysLimit');
    const $chart = document.getElementById('chart');
    const ctx = $chart.getContext('2d');
    const $mandatoryList = document.getElementById('mandatoryList');

    // ===========================
    // ОСНОВНАЯ ЛОГИКА
    // ===========================
    function recalcAll(){
      state.initial = Math.max(0, num($initial));
      state.target = Math.max(0, num($target));
      state.start = $start.value ? new Date($start.value) : null;
      state.end = $end.value ? new Date($end.value) : null;
      state.months = monthsDiffCeil(state.start, state.end);
      $monthsInfo.textContent = `Месяцев: ${state.months || '—'}`;

      if(state.months <= 0 || !state.start || !state.end){
        state.labels = [];
        state.monthlyTransactions = [];
        renderResults({availableTotal:null, monthlyLimit:null, mandatoryTotal:null, feasible:null, newMonthlyLimit:null, remTotal:null, sumActual:null, countSaved:null});
        $monthsList.innerHTML = '';
        drawChart([], [], [], []);
        $recommendationsBlock.classList.add('hidden');
        saveState();
        return;
      }

      state.labels = monthLabels(state.start, state.months);
      
      // Инициализация транзакций по месяцам
      if(state.monthlyTransactions.length !== state.months){
        const next = new Array(state.months).fill(null).map((_, i) => 
          state.monthlyTransactions[i] || []
        );
        state.monthlyTransactions = next;
      }

      // Расчёты с учетом обязательных платежей
      const mandatoryTotal = calculateTotalMandatory();
      const availableTotal = (state.initial - state.target) - mandatoryTotal;
      const monthlyLimit = availableTotal / state.months;
      
      // Подсчёт фактических трат
      const monthlyActuals = state.monthlyTransactions.map(transactions => 
        transactions.reduce((sum, t) => sum + (t.amount || 0), 0)
      );
      const countSaved = monthlyActuals.filter(v => v > 0).length;
      const sumActual = monthlyActuals.reduce((sum, v) => sum + v, 0);
      
      const remTotal = availableTotal - sumActual;
      const remainingMonths = Math.max(0, state.months - countSaved);
      const newMonthlyLimit = remainingMonths > 0 ? (remTotal / remainingMonths) : 0;
      const feasible = monthlyLimit >= 0 && remTotal >= 0;

      renderResults({
        availableTotal,
        monthlyLimit,
        mandatoryTotal,
        feasible,
        newMonthlyLimit,
        remTotal,
        sumActual,
        countSaved
      });

      renderMandatoryPayments();
      renderMonthsList(monthlyLimit, newMonthlyLimit);
      renderRecommendations(newMonthlyLimit);

      // График
      const plannedBalances = makePlannedBalances(state.initial, state.target, state.months);
      const { actualBalances, forecastBalances } = makeActualAndForecastBalances(
        plannedBalances, state.initial, monthlyActuals, newMonthlyLimit
      );
      drawChart(state.labels, plannedBalances, actualBalances, forecastBalances);

      saveState();
    }

    function renderMandatoryPayments(){
      if(state.mandatoryPayments.length === 0){
        $mandatoryList.innerHTML = '<div class="note">Нет обязательных платежей</div>';
        return;
      }

      $mandatoryList.innerHTML = '';
      state.mandatoryPayments.forEach((payment, idx) => {
        const div = document.createElement('div');
        div.className = 'mandatory-item';
        div.innerHTML = `
          <div class="mandatory-info">
            <div class="mandatory-name">${payment.name}</div>
            <div class="mandatory-details">Оплата: ${payment.dayOfMonth} числа каждого месяца</div>
          </div>
          <div class="mandatory-amount">${fmt0(payment.amount)}</div>
          <button class="btn danger small" onclick="deleteMandatory(${idx})">Удалить</button>
        `;
        $mandatoryList.appendChild(div);
      });
    }

    function renderRecommendations(monthlyLimit){
      if(!Number.isFinite(monthlyLimit) || monthlyLimit <= 0){
        $recommendationsBlock.classList.add('hidden');
        return;
      }
      $recommendationsBlock.classList.remove('hidden');
      const daily = monthlyLimit / 30;
      const weekly = monthlyLimit / 4.3;
      const tenDays = monthlyLimit / 3;
      
      $dailyLimit.textContent = fmtShort(daily) + ' ₽';
      $weeklyLimit.textContent = fmtShort(weekly) + ' ₽';
      $tenDaysLimit.textContent = fmtShort(tenDays) + ' ₽';
    }

    function makePlannedBalances(initial, target, months){
      const arr = [];
      for(let i=0;i<=months;i++){
        const t = i / months;
        const y = initial + (target - initial) * t;
        arr.push(y);
      }
      return arr;
    }

        function makeActualAndForecastBalances(planned, initial, monthlyActuals, newMonthlyLimit){
      const actual = [initial];
      let currentBalance = initial;
      let savedCount = 0;
      
      // Проходим по всем месяцам с фактическими тратами
      for(let i=0;i<monthlyActuals.length;i++){
        const v = monthlyActuals[i];
        const mandatoryForMonth = calculateMandatoryForMonth(i);
        
        if(v > 0){
          currentBalance = currentBalance - mandatoryForMonth - v;
          actual.push(currentBalance);
          savedCount++;
        }
        else {
          break;
        }
      }
      
      // Строим прогноз на оставшиеся месяцы
      const forecast = [];
      if(savedCount < state.months){
        forecast.push(currentBalance);
        
        // Считаем сколько осталось на все оставшиеся месяцы
        const totalAvailableForPeriod = (state.initial - state.target) - calculateTotalMandatory();
        const actualSpentWithoutMandatory = monthlyActuals.reduce((sum, v) => sum + v, 0);
        const remainingAfterActual = totalAvailableForPeriod - actualSpentWithoutMandatory;
        const remainingMonths = state.months - savedCount;
        const equalMonthlyLimit = remainingMonths > 0 ? remainingAfterActual / remainingMonths : 0;
        
        for(let i = savedCount; i < state.months; i++){
          const mandatoryForMonth = calculateMandatoryForMonth(i);
          const monthlyTotalSpend = mandatoryForMonth + Math.max(0, equalMonthlyLimit);
          currentBalance = currentBalance - monthlyTotalSpend;
          forecast.push(currentBalance);
        }
      }
      
      return { actualBalances: actual, forecastBalances: forecast };
    }


    function renderResults(data){
      const {
        availableTotal, monthlyLimit, mandatoryTotal,
        feasible, newMonthlyLimit, remTotal, sumActual, countSaved
      } = data;

      $availableTotal.textContent = fmt0(availableTotal);
      $monthlyLimit.textContent = Number.isFinite(monthlyLimit) ? fmt0(monthlyLimit) : '—';
      $mandatoryTotal.textContent = fmt0(mandatoryTotal);
      $feasibility.textContent = feasible===null ? '—' : (feasible ? 'Выполним ✓' : 'Невыполним ✗');
      $feasibilityTile.classList.toggle('warn', feasible===false);
      $feasibilityTile.classList.toggle('ok', feasible===true);
      $limitTile.classList.toggle('warn', Number.isFinite(monthlyLimit) && monthlyLimit < 0);
      $limitTile.classList.toggle('ok', Number.isFinite(monthlyLimit) && monthlyLimit >= 0);

      $countSaved.textContent = countSaved ?? '—';
      $sumActual.textContent = fmt0(sumActual);
      $remainingTotal.textContent = fmt0(remTotal);
      $newMonthlyLimit.textContent = Number.isFinite(newMonthlyLimit) ? fmt0(newMonthlyLimit) : '—';
      $newLimitTile.classList.toggle('warn', Number.isFinite(newMonthlyLimit) && newMonthlyLimit < 0);
      $newLimitTile.classList.toggle('ok', Number.isFinite(newMonthlyLimit) && newMonthlyLimit >= 0);

      const showUnfeasible = Number.isFinite(monthlyLimit) && monthlyLimit < 0;
      $unfeasibleMsg.classList.toggle('hidden', !showUnfeasible);
    }

        function renderMonthsList(baseMonthlyLimit, currentLimit){
  $monthsList.innerHTML = '';
  if(state.months <= 0) return;
  
  // Получаем фактические траты
  const monthlyActuals = state.monthlyTransactions.map(transactions => 
    transactions.reduce((sum, t) => sum + (t.amount || 0), 0)
  );

  state.labels.forEach((label, idx) => {
    const transactions = state.monthlyTransactions[idx] || [];
    const monthTotal = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
    const mandatoryForMonth = calculateMandatoryForMonth(idx);
    const hasTransactions = transactions.length > 0;
    const isCurrent = isCurrentMonth(idx);
    
    // Вычисляем динамический лимит для этого месяца
    const dynamicLimit = calculateDynamicLimitForMonth(idx, baseMonthlyLimit, monthlyActuals);
    
    // Рассчитываем среднюю трату за день для текущего месяца с новыми данными
    const dailyAverage = isCurrent ? calculateDailyAverage(idx, dynamicLimit) : null;
    
    const isOverspent = monthTotal > dynamicLimit;
    const isNegativeLimit = dynamicLimit < 0;

    const monthDiv = document.createElement('div');
    monthDiv.className = 'month' + (isCurrent ? ' current' : '');
    monthDiv.setAttribute('data-month-index', idx);
    
    // Определяем, должен ли месяц быть свернут
    const monthId = `month_${idx}`;
    const isCollapsed = !isCurrent && (state.collapsedMonths[monthId] !== false);
    if (isCollapsed) {
      monthDiv.classList.add('collapsed');
      state.collapsedMonths[monthId] = true;
    }
    
    if(isOverspent) monthDiv.style.borderColor = '#dc2626';
    if(isNegativeLimit) monthDiv.style.background = 'rgba(220, 38, 38, 0.1)';

    // Header с кнопкой сворачивания
    const header = document.createElement('div');
    header.className = 'month-header';
    
    const leftHeader = document.createElement('div');
    leftHeader.style.display = 'flex';
    leftHeader.style.alignItems = 'center';
    leftHeader.style.flex = '1';
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'month-name';
    nameDiv.textContent = label;
    if(isCurrent){
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = 'ТЕКУЩИЙ';
      nameDiv.appendChild(badge);
    }
    
    // Кнопка сворачивания/разворачивания
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'month-toggle-btn' + (isCollapsed ? ' collapsed' : '');
    toggleBtn.innerHTML = '▼';
    toggleBtn.title = isCollapsed ? 'Развернуть' : 'Свернуть';
    toggleBtn.onclick = (e) => {
      e.stopPropagation();
      toggleMonth(idx);
    };
    
    leftHeader.appendChild(nameDiv);
    leftHeader.appendChild(toggleBtn);

    const rightHeader = document.createElement('div');
    rightHeader.style.display = 'flex';
    rightHeader.style.alignItems = 'center';
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn accent icon small';
    addBtn.innerHTML = '+';
    addBtn.title = 'Добавить расход';
    addBtn.onclick = (e) => {
      e.stopPropagation();
      // Разворачиваем месяц при добавлении расхода
      if (state.collapsedMonths[monthId]) {
        toggleMonth(idx);
      }
      openAddExpenseModal(idx, label);
    };
    
    rightHeader.appendChild(addBtn);

    header.appendChild(leftHeader);
    header.appendChild(rightHeader);
    monthDiv.appendChild(header);

    // Контент месяца (скрывается при сворачивании)
    const monthContent = document.createElement('div');
    monthContent.className = 'month-content';
    
    // Добавляем обработчик клика для открытия детального просмотра
    monthContent.onclick = () => openMonthDetailModal(idx, label, dynamicLimit, monthTotal, mandatoryForMonth);
    monthContent.style.cursor = 'pointer';

    // Stats
    const stats = document.createElement('div');
    stats.className = 'month-stats';

    // Определяем какой план показывать
    let planLabel = 'План';
    let lastMonthWithExpenses = -1;
    for(let i = 0; i < monthlyActuals.length; i++){
      if(monthlyActuals[i] > 0) lastMonthWithExpenses = i;
    }
    
    if(idx === 0 && monthlyActuals[0] === 0){
      planLabel = 'План (базовый)';
    } else if(idx <= lastMonthWithExpenses){
      planLabel = 'План (базовый)';
    } else if(lastMonthWithExpenses >= 0){
      planLabel = 'План (перерасчет)';
    } else {
      planLabel = 'План (базовый)';
    }
    const statPlanned = createStatItem(planLabel, fmt0(dynamicLimit));
    if(isNegativeLimit) statPlanned.style.color = '#ff4444';
    
    const statMandatory = createStatItem('Обязательные', fmt0(mandatoryForMonth));
    const statActual = createStatItem('Потрачено', fmt0(monthTotal));
    if(isOverspent) statActual.style.color = '#ff4444';

    stats.appendChild(statPlanned);
    stats.appendChild(statMandatory);
    stats.appendChild(statActual);

    monthContent.appendChild(stats);
    
    // Добавляем блок со средней тратой за день для текущего месяца - НОВАЯ ВЕРСИЯ
    if(isCurrent && dailyAverage && dailyAverage.days > 0){
      const dailyAvgDiv = document.createElement('div');
      
      // Определяем класс стиля в зависимости от статуса
      let bgClass = 'daily-avg-normal';
      if(dailyAverage.status === 'good') bgClass = 'daily-avg-good';
      else if(dailyAverage.status === 'bad') bgClass = 'daily-avg-bad';
      
      dailyAvgDiv.className = bgClass;
      dailyAvgDiv.style.cssText = 'border-radius:8px; padding:10px; margin:10px 0; border: 1px solid;';
      
      // Определяем цвет для значений
      let valueClass = 'daily-avg-value';
      if(dailyAverage.status === 'good') valueClass += ' good';
      else if(dailyAverage.status === 'bad') valueClass += ' bad';
      
      // Формируем индикатор прогресса
      let progressClass = 'progress-indicator normal';
      let progressText = Math.round(dailyAverage.percentage) + '%';
      if(dailyAverage.status === 'good') {
        progressClass = 'progress-indicator good';
        progressText = '✓ ' + progressText;
      } else if(dailyAverage.status === 'bad') {
        progressClass = 'progress-indicator bad';
        progressText = '⚠ ' + progressText;
      }
      
      dailyAvgDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:start;">
          <div style="flex: 1;">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">
              Средняя трата в день
              <span class="${progressClass}">${progressText}</span>
            </div>
            <div style="font-size:16px; font-weight:700;" class="${valueClass}">
              ${fmt0(dailyAverage.average)}
              <span style="font-size:13px; font-weight:500; color:var(--muted); margin-left:4px;">
                (рек. ${fmt0(dailyAverage.recommendedDaily)})
              </span>
            </div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px;">
              за ${dailyAverage.days} ${dailyAverage.days === 1 ? 'день' : dailyAverage.days < 5 ? 'дня' : 'дней'}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:11px; color:var(--muted);">Всего потрачено:</div>
            <div style="font-size:14px; font-weight:600; color:var(--text);">
              ${fmt0(dailyAverage.total)}
            </div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px;">
              рек. ${fmt0(dailyAverage.recommendedTotal)}
            </div>
          </div>
        </div>
      `;
      monthContent.appendChild(dailyAvgDiv);
    }
    
    // Предупреждение если лимит отрицательный
    if(isNegativeLimit){
      const warning = document.createElement('div');
      warning.style.cssText = 'background:rgba(220,38,38,0.2);border:1px solid #dc2626;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;color:#ff8a8a;font-weight:600;';
      warning.textContent = '⚠️ Бюджет исчерпан! Требуется корректировка плана.';
      monthContent.appendChild(warning);
    }
    
    // Предупреждение о перерасходе
    if(isOverspent && !isNegativeLimit){
      const warning = document.createElement('div');
      warning.style.cssText = 'background:rgba(255,138,138,0.1);border:1px solid #ff8a8a;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;color:#ff8a8a;';
      const overspentAmount = monthTotal - dynamicLimit;
      warning.innerHTML = `⚠️ Перерасход: ${fmt0(overspentAmount)}`;
      monthContent.appendChild(warning);
    }

    // Показываем обязательные платежи для этого месяца
    if(mandatoryForMonth > 0){
      const mandatoryInfo = document.createElement('div');
      mandatoryInfo.style.cssText = 'background:#1a1f37;border:1px solid #4338ca;border-radius:6px;padding:8px;margin:8px 0;font-size:12px;';
      
      const paymentsForMonth = [];
      for(const payment of state.mandatoryPayments){
        const paymentDate = new Date(state.start.getFullYear(), state.start.getMonth() + idx, payment.dayOfMonth);
        if(paymentDate >= state.start && paymentDate <= state.end && paymentDate.getMonth() === (state.start.getMonth() + idx) % 12){
          paymentsForMonth.push(`${payment.name}: ${fmt0(payment.amount)} (${payment.dayOfMonth} числа)`);
        }
      }
      
      mandatoryInfo.innerHTML = `<div style="color:var(--purple);font-weight:600;margin-bottom:4px;">Обязательные платежи:</div>${paymentsForMonth.join('<br>')}`;
      monthContent.appendChild(mandatoryInfo);
    }

    // Transactions list
    if(hasTransactions){
      const transList = document.createElement('div');
      transList.className = 'transactions';
      
      transactions.forEach((t, tIdx) => {
        const transDiv = document.createElement('div');
        transDiv.className = 'transaction';
        
        const leftDiv = document.createElement('div');
        leftDiv.innerHTML = `
          <div>${t.description || 'Без описания'}</div>
          <div class="date">${new Date(t.date).toLocaleDateString('ru-RU')}</div>
        `;
        
        const rightDiv = document.createElement('div');
        rightDiv.style.display = 'flex';
        rightDiv.style.gap = '8px';
        rightDiv.style.alignItems = 'center';
        
        const amountSpan = document.createElement('span');
        amountSpan.className = 'amount';
        amountSpan.textContent = fmt0(t.amount);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn ghost small';
        delBtn.textContent = '×';
        delBtn.style.padding = '2px 8px';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deleteTransaction(idx, tIdx);
        };
        
        rightDiv.appendChild(amountSpan);
        rightDiv.appendChild(delBtn);
        
        transDiv.appendChild(leftDiv);
        transDiv.appendChild(rightDiv);
        transList.appendChild(transDiv);
      });
      
      monthContent.appendChild(transList);
    }

    monthDiv.appendChild(monthContent);
    $monthsList.appendChild(monthDiv);
  });
}



    function createStatItem(label, value){
      const div = document.createElement('div');
      div.className = 'stat-item';
      div.innerHTML = `
        <div class="stat-label">${label}</div>
        <div class="stat-value">${value}</div>
      `;
      return div;
    }

    // ===========================
    // МОДАЛЬНЫЕ ОКНА
    // ===========================
    function openAddExpenseModal(monthIndex, monthLabel){
      state.currentModalMonth = monthIndex;
      document.getElementById('modalMonth').value = monthLabel;
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDesc').value = '';
      document.getElementById('addExpenseModal').classList.add('show');
      document.getElementById('expenseAmount').focus();
    }

    function closeModal(){
      document.getElementById('addExpenseModal').classList.remove('show');
      state.currentModalMonth = -1;
    }

    function saveExpense(){
      const amount = parseFloat(document.getElementById('expenseAmount').value.replace(',', '.'));
      const description = document.getElementById('expenseDesc').value.trim();
      
      if(!Number.isFinite(amount) || amount <= 0){
        document.getElementById('expenseAmount').focus();
        return;
      }
      
      if(state.currentModalMonth >= 0 && state.currentModalMonth < state.months){
        if(!state.monthlyTransactions[state.currentModalMonth]){
          state.monthlyTransactions[state.currentModalMonth] = [];
        }
        
        state.monthlyTransactions[state.currentModalMonth].push({
          amount,
          description: description || 'Без описания',
          date: new Date().toISOString()
        });
        
        closeModal();
        recalcAll();
      }
    }

    function openMandatoryModal(){
      document.getElementById('mandatoryName').value = '';
      document.getElementById('mandatoryAmount').value = '';
      document.getElementById('mandatoryDay').value = '';
      document.getElementById('mandatoryModal').classList.add('show');
      document.getElementById('mandatoryName').focus();
    }

    function closeMandatoryModal(){
      document.getElementById('mandatoryModal').classList.remove('show');
    }

    function saveMandatory(){
      const name = document.getElementById('mandatoryName').value.trim();
      const amount = parseFloat(document.getElementById('mandatoryAmount').value.replace(',', '.'));
      const day = parseInt(document.getElementById('mandatoryDay').value);
      
      if(!name){
        document.getElementById('mandatoryName').focus();
        return;
      }
      
      if(!Number.isFinite(amount) || amount <= 0){
        document.getElementById('mandatoryAmount').focus();
        return;
      }
      
      if(!Number.isFinite(day) || day < 1 || day > 31){
        document.getElementById('mandatoryDay').focus();
        return;
      }
      
      state.mandatoryPayments.push({
        name,
        amount,
        dayOfMonth: day
      });
      
      closeMandatoryModal();
      recalcAll();
    }

    function deleteMandatory(index){
      if(confirm('Удалить этот обязательный платеж?')){
        state.mandatoryPayments.splice(index, 1);
        recalcAll();
      }
    }

        // ===========================
    // ДЕТАЛЬНЫЙ ПРОСМОТР МЕСЯЦА
    // ===========================
    function openMonthDetailModal(monthIndex, monthLabel, plannedAmount, actualSpent, mandatoryAmount){
      document.getElementById('monthDetailTitle').textContent = 'Детали: ' + monthLabel;
      
      // Расчёты
      const available = Math.max(0, plannedAmount - actualSpent);
      const spentInPlan = Math.min(actualSpent, plannedAmount);
      const overspent = Math.max(0, actualSpent - plannedAmount);
      const balance = plannedAmount - actualSpent;
      
      // Рассчитываем среднюю трату за день
      const dailyAverage = calculateDailyAverage(monthIndex);
      
      // Обновляем статистику
      document.getElementById('detailPlan').textContent = fmt0(plannedAmount);
      document.getElementById('detailMandatory').textContent = fmt0(mandatoryAmount);
      document.getElementById('detailActual').textContent = fmt0(actualSpent);
      
      const balanceEl = document.getElementById('detailBalance');
      balanceEl.textContent = fmt0(Math.abs(balance));
      balanceEl.className = 'detail-stat-value';
      if(balance < 0){
        balanceEl.classList.add('overspent');
        balanceEl.textContent = '−' + fmt0(Math.abs(balance));
      } else {
        balanceEl.textContent = '+' + fmt0(balance);
      }
      
      // Добавляем среднюю трату в модальное окно, если это текущий месяц
      const detailStatsDiv = document.querySelector('.detail-stats');
      const existingDailyAvg = document.getElementById('dailyAvgStat');
      if(existingDailyAvg) existingDailyAvg.remove();
      
      if(dailyAverage && dailyAverage.days > 0){
        const dailyAvgStat = document.createElement('div');
        dailyAvgStat.id = 'dailyAvgStat';
        dailyAvgStat.className = 'detail-stat';
        dailyAvgStat.style.gridColumn = 'span 2';
        dailyAvgStat.style.background = 'linear-gradient(135deg, rgba(109,211,251,.08), rgba(167,139,250,.08))';
        dailyAvgStat.style.border = '1px solid #4338ca';
        dailyAvgStat.innerHTML = `
          <div class="detail-stat-label">Средняя трата в день (за ${dailyAverage.days} ${dailyAverage.days === 1 ? 'день' : dailyAverage.days < 5 ? 'дня' : 'дней'})</div>
          <div class="detail-stat-value" style="color:var(--accent);">${fmt0(dailyAverage.average)}</div>
        `;
        detailStatsDiv.appendChild(dailyAvgStat);
      }
      
      // Обновляем легенду
      document.getElementById('legendAvailable').textContent = fmt0(available);
      document.getElementById('legendSpent').textContent = fmt0(spentInPlan);
      
      const overspentLegend = document.getElementById('overspentLegend');
      if(overspent > 0){
        overspentLegend.style.display = 'flex';
        document.getElementById('legendOverspent').textContent = fmt0(overspent);
      } else {
        overspentLegend.style.display = 'none';
      }
      
      // Рисуем круговую диаграмму
      drawPieChart(plannedAmount, actualSpent);
      
      // Показываем модальное окно
      document.getElementById('monthDetailModal').classList.add('show');
    }
    
    function closeMonthDetailModal(){
      document.getElementById('monthDetailModal').classList.remove('show');
    }
    
    function drawPieChart(planned, spent){
      const canvas = document.getElementById('pieChart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;
      
      // Очищаем canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Вычисляем углы
      const total = Math.max(planned, spent);
      if(total <= 0) return;
      
      const spentInPlan = Math.min(spent, planned);
      const overspent = Math.max(0, spent - planned);
      const available = Math.max(0, planned - spent);
      
      // Начальный угол (сверху)
      let currentAngle = -Math.PI / 2;
      
      // Рисуем доступную часть (зелёный)
      if(available > 0){
        const availableAngle = (available / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + availableAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#4ade80';
        ctx.fill();
        currentAngle += availableAngle;
      }
      
      // Рисуем потраченную в пределах плана часть (красный)
      if(spentInPlan > 0){
        const spentAngle = (spentInPlan / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + spentAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#ff8a8a';
        ctx.fill();
        currentAngle += spentAngle;
      }
      
      // Рисуем перерасход (алый)
      if(overspent > 0){
        const overspentAngle = (overspent / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + overspentAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#ff4444';
        ctx.fill();
      }
      
      // Рисуем белую обводку
      ctx.strokeStyle = '#27305a';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();
      
      // Добавляем текст в центре
      ctx.fillStyle = '#e8ecff';
      ctx.font = 'bold 14px Inter, system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      const percentage = planned > 0 ? Math.round((spent / planned) * 100) : 0;
      ctx.fillText(percentage + '%', centerX, centerY - 10);
      ctx.font = '12px Inter, system-ui, sans-serif';
      ctx.fillStyle = '#8e97b3';
      ctx.fillText('использовано', centerX, centerY + 10);
    }


    function deleteTransaction(monthIndex, transactionIndex){
      if(confirm('Удалить эту трату?')){
        state.monthlyTransactions[monthIndex].splice(transactionIndex, 1);
        recalcAll();
      }
    }

    // ===========================
    // ГРАФИК
    // ===========================
    function drawChart(labels, planned, actual, forecast){
      const w = $chart.width, h = $chart.height;
      ctx.clearRect(0,0,w,h);

      const padL = 60, padR = 16, padT = 14, padB = 38;
      const gw = w - padL - padR;
      const gh = h - padT - padB;

      const ys = []
        .concat(Array.isArray(planned)?planned:[])
        .concat(Array.isArray(actual)?actual:[])
        .concat(Array.isArray(forecast)?forecast:[])
        .filter(Number.isFinite);

      if(ys.length === 0){
        drawGrid(padL, padT, gw, gh, 4, 4);
        return;
      }

      let yMin = Math.min(...ys), yMax = Math.max(...ys);
      const pad = Math.max(1000, (yMax - yMin)*0.08);
      yMin -= pad; yMax += pad;
      if(yMax === yMin){ yMax += 1; yMin -= 1; }

      drawGrid(padL, padT, gw, gh, 5, labels.length || 4);
      drawYTicks(padL, padT, gw, gh, yMin, yMax, 5);
      drawXLabels(labels, padL, padT, gw, gh);

      const X = (i, totalPoints)=>{
        const t = totalPoints === 0 ? 0 : i / totalPoints;
        return padL + t * gw;
      };
      const Y = (val)=>{
        const t = (val - yMin) / (yMax - yMin);
        return padT + (1 - t) * gh;
      };

      // План
      if(planned && planned.length){
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line1').trim();
        ctx.beginPath();
        for(let i=0;i<planned.length;i++){
          const x = X(i, planned.length-1), y = Y(planned[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      // Фактический
      if(actual && actual.length){
        ctx.lineWidth = 3;
        ctx.setLineDash([]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line2').trim();
        ctx.beginPath();
        for(let i=0;i<actual.length;i++){
          const x = X(i, (planned?.length||1)-1), y = Y(actual[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        
        // Точки
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--line2').trim();
        for(let i=0;i<actual.length;i++){
          const x = X(i, (planned?.length||1)-1), y = Y(actual[i]);
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Прогноз
      if(forecast && forecast.length){
        ctx.lineWidth = 2;
        ctx.setLineDash([8,4]);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line3').trim();
        ctx.beginPath();
        const totalPoints = (planned?.length||1)-1;
        const startIndex = (actual?.length||1)-1;
        for(let i=0;i<forecast.length;i++){
          const x = X(startIndex + i, totalPoints);
          const y = Y(forecast[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    function drawGrid(x, y, w, h, rows, cols){
      ctx.save();
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.3;

      for(let c=0;c<=cols;c++){
        const xx = x + (w * c/cols);
        ctx.beginPath();
        ctx.moveTo(xx, y);
        ctx.lineTo(xx, y+h);
        ctx.stroke();
      }
      for(let r=0;r<=rows;r++){
        const yy = y + (h * r/rows);
        ctx.beginPath();
        ctx.moveTo(x, yy);
        ctx.lineTo(x+w, yy);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawYTicks(x, y, w, h, vmin, vmax, rows){
      ctx.save();
      ctx.fillStyle = '#8e97b3';
      ctx.font = '11px system-ui, sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for(let r=0;r<=rows;r++){
        const t = r/rows;
        const yy = y + (h * t);
        const val = vmax - (vmax - vmin)*t;
        const label = fmtShort(val) + ' ₽';
        ctx.fillText(label, x - 8, yy);
      }
      ctx.restore();
    }

    function drawXLabels(labels, x, y, w, h){
      if(!labels || !labels.length) return;
      ctx.save();
      ctx.fillStyle = '#8e97b3';
      ctx.font = '11px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      const total = labels.length-1;
      for(let i=0;i<labels.length;i++){
        const xx = x + (w * (i/total||0));
        const shortLabel = labels[i].slice(0, 3);
        ctx.fillText(shortLabel, xx, y + h + 8);
      }
      ctx.restore();
    }

    // ===========================
    // ОБРАБОТЧИКИ
    // ===========================
    $calcBtn.addEventListener('click', recalcAll);
    $resetBtn.addEventListener('click', () => {
      $initial.value = '';
      $target.value = '';
      $start.value = '';
      $end.value = '';
      Object.assign(state, {
        initial:0,
        target:0,
        start:null,
        end:null,
        months:0,
        mandatoryPayments:[],
        monthlyTransactions:[],
        labels:[],
        collapsedMonths:{} // Добавьте эту строку
      });
      localStorage.removeItem(STORAGE_KEY);
      recalcAll();
    });

    $start.addEventListener('change', recalcAll);
    $end.addEventListener('change', recalcAll);

    // Закрытие модальных окон по клику вне их
    document.getElementById('addExpenseModal').addEventListener('click', (e) => {
      if(e.target.id === 'addExpenseModal'){
        closeModal();
      }
    });
    
    document.getElementById('mandatoryModal').addEventListener('click', (e) => {
      if(e.target.id === 'mandatoryModal'){
        closeMandatoryModal();
      }
    });

        document.getElementById('monthDetailModal').addEventListener('click', (e) => {
      if(e.target.id === 'monthDetailModal'){
        closeMonthDetailModal();
      }
    });


    // Закрытие по Escape
        // Закрытие по Escape
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        closeModal();
        closeMandatoryModal();
        closeMonthDetailModal();
      }
    });

    // ===========================
    // ИНИЦИАЛИЗАЦИЯ
    // ===========================
    (function init(){
      loadState();
      
      if(state.initial) $initial.value = String(state.initial);
      if(state.target) $target.value = String(state.target);
      if(state.start) $start.valueAsDate = state.start;
      if(state.end) $end.valueAsDate = state.end;

      recalcAll();

      // Демо-данные если пусто
      if(!state.start && !state.end && !$initial.value && !$target.value){
        $initial.value = '150000';
        $target.value = '30000';
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        const end = new Date(today.getFullYear(), today.getMonth() + 3, 0);
        $start.valueAsDate = start;
        $end.valueAsDate = end;
        
        // Демо обязательные платежи
        state.mandatoryPayments = [
          {name: 'Аренда квартиры', amount: 25000, dayOfMonth: 5},
          {name: 'Интернет', amount: 800, dayOfMonth: 10}
        ];
        
        recalcAll();
      }
    })();
  </script>
</body>
</html>
